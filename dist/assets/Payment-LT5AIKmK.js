import{a7 as xe,u as ue,a as he,g as pe,a6 as ge,r as l,j as e,B as d,H as be,C as fe,x as p,T as s,V as g,G as x,O as ye,o as je,p as ve,l as k,b as G,i as Se,e as U}from"./index-lVPGhRyu.js";import{S as Y}from"./StepTracker-CHO5MGKx.js";import{S as K}from"./SeatCountdown-CVQnsF_I.js";import"./Stepper-CircRhHr.js";import"./CancelOutlined-D0IogPuA.js";import"./CheckCircleOutline-BEGCYRkM.js";import"./AccessTime-DdUZbJCX.js";import"./EventSeat-BiIDcJU-.js";const Ee=()=>{const Q=xe(),b=ue(),{t:r}=he(),{userDetails:m}=pe(),{connection:u,isConnected:v}=ge(),[B,X]=l.useState([]),[c,E]=l.useState(null),[Z,R]=l.useState(!1),ee=Q.state||{},{selectedTime:V="Not selected",selectedDate:L="Not selected",tickets:w=[],seats:P=[],showTimeId:te="",selectedSeatsInfo:n=[],movieData:a={},roomName:W="",lastSelectionTime:f,resetCounter:C=0}=ee,re=(a==null?void 0:a.movieName)||r("payment.movie.default"),oe=L,se=V,h=te||sessionStorage.getItem("currentShowTimeId")||"";l.useEffect(()=>{const t=o=>{if(u&&v&&h&&(n!=null&&n.length)){o.preventDefault(),o.returnValue="";const i=m==null?void 0:m.userId,j=JSON.stringify({ticketRequests:n.map(J=>({TicketId:J.ticketId,Version:J.version})),showtimeId:h,userId:i});return navigator.sendBeacon("/api/seats/release-pending",j),""}};return window.addEventListener("beforeunload",t),()=>{window.removeEventListener("beforeunload",t)}},[u,v,h,n]),l.useEffect(()=>()=>{if(u&&v&&(n==null?void 0:n.length)>0){const t=m==null?void 0:m.userId,o=n.map(i=>({TicketId:i.ticketId,Version:i.version}));u.invoke("ReleasePendingSeats",o,h,t).catch(i=>console.error("Failed to release seats on unmount:",i))}},[u,v,n,h]);const ne=async()=>{if(u&&(n==null?void 0:n.length)>0)try{const t=m==null?void 0:m.userId,o=n.map(i=>({TicketId:i.ticketId,Version:i.version}));await u.invoke("ReleasePendingSeats",o,h,t),g.success(r("toast.success.seat.cancel_booking")),b(-1)}catch(t){console.error("Error releasing seats:",t),g.error(r("toast.error.seat.cancel_booking")),b(-1)}else b(-1)};l.useEffect(()=>{(async()=>{R(!0);try{const o=await U.get("promotions"),i=o.data.data||o.data||[];X(i),console.log("Loaded promotions:",i)}catch(o){console.error("Failed to load promotions",o),g.error(r("toast.error.promotion.loading"))}finally{R(!1)}})()},[]);const ie=l.useCallback(t=>{if(!c)return t;const o=t*(c.discount/100);return Math.max(0,t-o)},[c]),y=(w||[]).reduce((t,o)=>t+o.price*(o.quantity||0),0),F=ie(y),S=F,[I,ae]=l.useState(""),[T,le]=l.useState(""),[z,de]=l.useState(""),[N,ce]=l.useState(""),[_,O]=l.useState(!1),[D,M]=l.useState(!1),[H,$]=l.useState(!1),[A,q]=l.useState(!1),me=async()=>{let t=!1;if(I.trim()?O(!1):(O(!0),t=!0),T.trim()?M(!1):(M(!0),t=!0),z.trim()?$(!1):($(!0),t=!0),N.trim()?q(!1):(q(!0),t=!0),!t)try{const o={totalTicket:w.length,amount:S,promotionId:(c==null?void 0:c.promotionId)||null,tickets:n.map(j=>j.ticketId)},i=await U.post(`vnpay/createpaymenturl?money=${S}&description=${encodeURIComponent(`Payment for movie tickets: ${a==null?void 0:a.movieName}`)}&userId=${m==null?void 0:m.userId}`,o);sessionStorage.setItem("bookingInfo",JSON.stringify({selectedTime:V,selectedDate:L,tickets:w,seats:P,totalPrice:y,total:S,fullName:I,email:T,idNumber:z,phone:N,selectedSeatsInfo:n,lastSelectionTime:f,resetCounter:C,movieData:a,roomName:W,promotion:c})),window.location.href=i.data}catch(o){console.error(o),g.error(r("toast.error.ticket.booking"));return}};return e.jsxs(d,{sx:{minHeight:"100vh",background:`linear-gradient(to bottom,
          rgba(11, 13, 26, 0.95) 0%,
          rgba(11, 13, 26, 0.85) 100%
        )`,position:"relative","&::before":{content:'""',position:"fixed",top:0,left:0,right:0,bottom:0,background:`radial-gradient(circle at 20% 30%, rgba(78, 46, 131, 0.4) 0%, rgba(78, 46, 131, 0) 50%),
                      radial-gradient(circle at 75% 15%, rgba(33, 64, 154, 0.4) 0%, rgba(33, 64, 154, 0) 50%),
                      linear-gradient(135deg, #0B0D1A 0%, #1A1E3C 50%, #3A1155 100%)`,zIndex:-1}},children:[e.jsx(be,{}),e.jsx(fe,{maxWidth:"xl",sx:{pt:{xs:"64px",sm:"72px",md:"80px"},pb:{xs:4,sm:6,md:8},px:{xs:2,sm:3,md:4},position:"relative"},children:e.jsxs(d,{sx:{display:"flex",gap:{xs:2,sm:3,md:4},color:"white",position:"relative",minHeight:"100vh"},children:[e.jsxs(d,{sx:{flex:1,display:"flex",flexDirection:"column",gap:{xs:2,sm:3,md:4},pb:4},children:[e.jsxs(d,{sx:{display:{xs:"block",md:"none"},mb:2},children:[f&&e.jsx(d,{sx:{display:"flex",justifyContent:"center",mb:3},children:e.jsxs(p,{elevation:3,sx:{p:2,backgroundColor:"rgba(27, 38, 53, 0.8)",borderRadius:2,width:"100%"},children:[e.jsx(s,{variant:"subtitle1",align:"center",sx:{mb:1,color:"#fbc02d"},children:r("payment.timer")}),e.jsx(K,{seatId:"payment-timer-mobile",seatName:"Timer",startTime:f,resetTrigger:C,onTimeout:()=>{g.error(r("toast.error.seat.remainder")),b(`/ticket/${a.movieId}`,{replace:!0})}})]})}),e.jsx(Y,{currentStep:3})]}),e.jsx(s,{variant:"h4",fontWeight:"bold",align:"center",gutterBottom:!0,fontFamily:"JetBrains Mono",sx:{textTransform:"uppercase",mb:2,letterSpacing:"1.2px",lineHeight:"1.5"},children:r("payment.ticket.payment")}),e.jsxs(x,{container:!0,spacing:4,children:[e.jsx(x,{item:!0,xs:12,md:4,children:e.jsx(p,{sx:{p:2,backgroundColor:"rgba(28, 28, 28, 0.8)",color:"white"},children:e.jsx(d,{component:"img",src:a==null?void 0:a.image,alt:a==null?void 0:a.movieName,sx:{width:"100%",height:"auto",borderRadius:.5,border:"1px solid",borderColor:"#f1f1f1",boxShadow:"0 0 20px rgba(0,0,0,0.5)",objectFit:"cover"}})})}),e.jsxs(x,{item:!0,xs:12,md:8,children:[e.jsx(p,{sx:{p:{xs:3,md:4},backgroundColor:"rgba(28, 28, 28, 0.8)",color:"white",mb:{xs:3,md:4}},children:e.jsxs(x,{container:!0,spacing:3,children:[e.jsxs(x,{item:!0,xs:12,sm:6,children:[e.jsx(s,{variant:"h6",gutterBottom:!0,sx:{fontSize:{xs:"1.3rem",md:"1.5rem"}},children:r("payment.movie.description")}),e.jsxs(s,{variant:"body1",gutterBottom:!0,sx:{fontSize:{xs:"1.1rem",md:"1.3rem"}},children:[e.jsx("strong",{children:r("payment.movie.name")})," ",re]}),e.jsxs(s,{variant:"body1",gutterBottom:!0,sx:{fontSize:{xs:"1.1rem",md:"1.3rem"}},children:[e.jsx("strong",{children:r("payment.movie.room")})," ",W]}),e.jsxs(s,{variant:"body1",gutterBottom:!0,sx:{fontSize:{xs:"1.1rem",md:"1.3rem"}},children:[e.jsx("strong",{children:r("payment.showtime.day")})," ",oe]}),e.jsxs(s,{variant:"body1",gutterBottom:!0,sx:{fontSize:{xs:"1.1rem",md:"1.3rem"}},children:[e.jsx("strong",{children:r("payment.showtime.hour")})," ",se]})]}),e.jsxs(x,{item:!0,xs:12,sm:6,children:[e.jsx(s,{variant:"h6",gutterBottom:!0,sx:{fontSize:{xs:"1.3rem",md:"1.5rem"}},children:r("payment.ticket.infor")}),e.jsxs(s,{variant:"body1",gutterBottom:!0,sx:{fontSize:{xs:"1.1rem",md:"1.3rem"}},children:[e.jsx("strong",{children:r("payment.ticket.seat")})," ",P.join(", ")||"Chưa chọn ghế"]}),e.jsxs(s,{variant:"body1",gutterBottom:!0,sx:{fontSize:{xs:"1.1rem",md:"1.3rem"}},children:[e.jsx("strong",{children:r("payment.ticket.price")})," ",y.toLocaleString("vi-VN",{style:"currency",currency:"VND"})]}),e.jsxs(s,{variant:"body1",gutterBottom:!0,sx:{color:"#fbc02d",fontWeight:"bold",fontSize:{xs:"1.2rem",md:"1.4rem"},mt:1},children:[e.jsx("strong",{children:r("payment.total_amount")})," ",S.toLocaleString("vi-VN",{style:"currency",currency:"VND"}),c&&e.jsxs(s,{component:"span",sx:{color:"#4caf50",ml:1,fontSize:{xs:"1rem",md:"1.1rem"}},children:["(",r("payment.promotion.used"),")"]})]}),e.jsxs(p,{sx:{p:{xs:2,md:3},backgroundColor:"rgba(28, 28, 28, 0.8)",color:"white",mb:{xs:3,md:4}},children:[e.jsx(s,{variant:"h6",gutterBottom:!0,sx:{fontSize:{xs:"1.3rem",md:"1.5rem"}},children:r("payment.promotion.title")}),Z?e.jsx(d,{sx:{display:"flex",justifyContent:"center",my:2},children:e.jsx(ye,{size:28,sx:{color:"#fbc02d"}})}):B.length===0?e.jsx(s,{variant:"body2",color:"text.secondary",sx:{fontStyle:"italic",fontSize:{xs:"1rem",md:"1.1rem"}},children:r("payment.promotion.notfound")}):e.jsx(d,{sx:{maxHeight:"250px",overflowY:"auto",pr:1,"&::-webkit-scrollbar":{width:"8px"},"&::-webkit-scrollbar-track":{background:"rgba(0,0,0,0.1)",borderRadius:"4px"},"&::-webkit-scrollbar-thumb":{background:"rgba(255,255,255,0.2)",borderRadius:"4px","&:hover":{background:"rgba(255,255,255,0.3)"}}},children:B.map(t=>{const o=new Date(t.toDate)<new Date,i=(c==null?void 0:c.promotionId)===t.promotionId;return e.jsx(je,{disabled:o,control:e.jsx(ve,{checked:i,onChange:j=>{j.target.checked?o||E(t):E(null)},sx:{color:o?"grey":"white","&.Mui-checked":{color:"#fbc02d"}}}),label:e.jsxs(d,{sx:{backgroundColor:o?"rgba(0,0,0,0.2)":"transparent",p:1,borderRadius:1},children:[e.jsx(s,{variant:"body1",fontWeight:"bold",sx:{fontSize:{xs:"1.1rem",md:"1.3rem"}},children:t.promotionName}),e.jsxs(d,{sx:{display:"flex",gap:2,mb:1},children:[t.image&&e.jsx(d,{component:"img",src:t.image,sx:{width:80,height:50,objectFit:"cover",borderRadius:1}}),e.jsxs(s,{variant:"body2",sx:{color:o?"grey":"#fbc02d",fontSize:{xs:"1rem",md:"1.1rem"}},children:[r("payment.promotion.discount")," ",t.discount,"%"]})]}),e.jsxs(s,{variant:"caption",sx:{color:o?"grey":"#bdbdbd",fontSize:{xs:"0.9rem",md:"1rem"}},children:[r("payment.promotion.from")," ",new Date(t.fromDate).toLocaleDateString("vi-VN")," ",r("payment.promotion.to")," ",new Date(t.toDate).toLocaleDateString("vi-VN")]})]}),sx:{mb:2,alignItems:"flex-start",opacity:o?.5:1}},t.promotionId)})}),c&&e.jsxs(d,{sx:{mt:2,borderTop:"1px solid rgba(255,255,255,0.1)",pt:2},children:[e.jsxs(s,{variant:"body1",sx:{fontSize:{xs:"1.1rem",md:"1.3rem"}},children:[e.jsx("strong",{children:r("payment.origin_price")})," ",y.toLocaleString("vi-VN",{style:"currency",currency:"VND"})]}),e.jsxs(s,{variant:"body1",sx:{color:"#4caf50",fontSize:{xs:"1.1rem",md:"1.3rem"}},children:[e.jsxs("strong",{children:[r("payment.promotion.discount")," (",c.discount,"%):"]})," ",(y-F).toLocaleString("vi-VN",{style:"currency",currency:"VND"})]})]})]})]})]})}),e.jsxs(p,{sx:{p:{xs:3,md:4},backgroundColor:"rgba(28, 28, 28, 0.8)",color:"white"},children:[e.jsx(s,{variant:"h6",gutterBottom:!0,sx:{fontSize:{xs:"1.3rem",md:"1.5rem"}},children:r("payment.user_infor")}),e.jsxs(x,{container:!0,spacing:2,sx:{mb:2},children:[e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(k,{label:r("common.table_header.user.fullname"),variant:"outlined",fullWidth:!0,value:I,onChange:t=>ae(t.target.value),error:_,helperText:_?r("helperText.error.fullname"):"",sx:{maxWidth:"400px",input:{color:"white",fontSize:{xs:"1.1rem",md:"1.2rem"}},"& label":{color:"rgba(255,255,255,0.7)",fontSize:{xs:"1.1rem",md:"1.2rem"}},"& .MuiOutlinedInput-root":{"& fieldset":{borderColor:"rgba(255,255,255,0.3)"},"&:hover fieldset":{borderColor:"white"}}}})}),e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(k,{label:r("common.table_header.user.email"),variant:"outlined",fullWidth:!0,value:T,onChange:t=>le(t.target.value),error:D,helperText:D?r("helperText.error.email"):"",sx:{maxWidth:"400px",input:{color:"white",fontSize:{xs:"1.1rem",md:"1.2rem"}},"& label":{color:"rgba(255,255,255,0.7)",fontSize:{xs:"1.1rem",md:"1.2rem"}},"& .MuiOutlinedInput-root":{"& fieldset":{borderColor:"rgba(255,255,255,0.3)"},"&:hover fieldset":{borderColor:"white"}}}})}),e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(k,{label:r("auth.signup.fields.id_card"),variant:"outlined",fullWidth:!0,value:z,onChange:t=>de(t.target.value),error:H,helperText:H?r("helperText.error.id_number"):"",sx:{maxWidth:"400px",input:{color:"white",fontSize:{xs:"1.1rem",md:"1.2rem"}},"& label":{color:"rgba(255,255,255,0.7)",fontSize:{xs:"1.1rem",md:"1.2rem"}},"& .MuiOutlinedInput-root":{"& fieldset":{borderColor:"rgba(255,255,255,0.3)"},"&:hover fieldset":{borderColor:"white"}}}})}),e.jsx(x,{item:!0,xs:12,sm:6,children:e.jsx(k,{label:r("common.table_header.user.phone"),variant:"outlined",fullWidth:!0,value:N,onChange:t=>ce(t.target.value),error:A,helperText:A?r("helperText.error.phone"):"",sx:{maxWidth:"400px",input:{color:"white",fontSize:{xs:"1.1rem",md:"1.2rem"}},"& label":{color:"rgba(255,255,255,0.7)",fontSize:{xs:"1.1rem",md:"1.2rem"}},"& .MuiOutlinedInput-root":{"& fieldset":{borderColor:"rgba(255,255,255,0.3)"},"&:hover fieldset":{borderColor:"white"}}}})})]}),e.jsxs(d,{sx:{textAlign:"center",mt:3},children:[e.jsx(G,{variant:"outlined",onClick:ne,sx:{color:"#fbc02d",borderColor:"#fbc02d",mr:2,px:4,py:1.2,fontSize:{xs:"1rem",md:"1.2rem"},borderRadius:2,"&:hover":{borderColor:"#ff9800",backgroundColor:"rgba(251, 192, 45, 0.1)"}},children:r("payment.back")}),e.jsx(G,{variant:"contained",onClick:me,sx:{background:"linear-gradient(135deg, #fbc02d 0%, #ff9800 100%)",color:"#121212",px:4,py:1.2,fontSize:{xs:"1rem",md:"1.2rem"},borderRadius:2,"&:hover":{background:"linear-gradient(135deg, #ff9800 0%, #fbc02d 100%)"}},children:r("payment.confirm")})]})]})]})]})]}),e.jsxs(d,{sx:{display:{xs:"none",md:"block"},position:"relative",alignSelf:"flex-start",width:"15%",height:"100%",flexShrink:0,mt:{xs:2,sm:3,md:4}},children:[f&&e.jsxs(p,{elevation:3,sx:{p:2,backgroundColor:"rgba(27, 38, 53, 0.8)",borderRadius:2,width:"100%",display:"flex",flexDirection:"column",gap:2,mb:3,position:"relative",zIndex:2},children:[e.jsx(s,{variant:"subtitle1",align:"center",sx:{color:"#fbc02d"},children:r("payment.timer")}),e.jsx(K,{seatId:"payment-timer",seatName:"Timer",startTime:f,resetTrigger:C,onTimeout:()=>{g.error(r("toast.error.seat.remainder")),b(`/ticket/${a.movieId}`,{replace:!0})}})]}),e.jsx(d,{sx:{width:"100%",height:"200px",position:"relative"},children:e.jsx(Y,{currentStep:3})})]})]})}),e.jsx(Se,{})]})};export{Ee as default};
