import{a as W,a5 as D,g as H,r as I,V as j,j as e,L as J,B as h,e as Q,T as p,b as P,a6 as X,u as Y,C as Z,x as M}from"./index-ChydTw30.js";import{E as A}from"./EventSeat-aEO-43H7.js";import{S as O}from"./SeatCountdown-DvKBlndn.js";import{S as F}from"./StepTracker-CV_dtooZ.js";import{S as ee}from"./ShowTimeLayout-CY6-m8_o.js";import"./AccessTime-CfgiFXmd.js";import"./Stepper-xW1gzkH4.js";import"./CancelOutlined-3QiGv90u.js";import"./CheckCircleOutline-BBlTMT46.js";import"./UserDetailLayout-Bdf3zFhg.js";const te=(y,m,n)=>{const R=y.seat.atRow,C=n.filter(i=>i.seat.atRow===R);C.sort((i,b)=>i.seat.atColumn-b.seat.atColumn);const d=C.map(i=>!!(i.status===1||i.status===2||m.some(b=>b.id===i.seatId)||i.seatId===y.seatId));for(let i=1;i<d.length-1;i++)if(!d[i]&&d[i-1]&&d[i+1])return!0;return!1},se=({ticket:y,isSelectedByMe:m,canSelect:n,handleSeatClick:R})=>{const C=y.status===1,d=y.status===2,i=y.seat.seatType.typeName==="VIP",b=y.seat.seatType.typeName==="Couple",T=y.seat.seatType.seatTypeId,S=!n||C||d;let _="white",v="transparent";return m?(_="green",v="rgba(0, 255, 0, 0.2)"):d?(_="red",v="rgba(255, 0, 0, 0.2)"):C?(_="yellow",v="rgba(255, 255, 0, 0.2)"):i?(_=n?"blue":"gray",v=n?"rgba(0, 0, 255, 0.2)":"rgba(128, 128, 128, 0.2)"):b?(_=n?"purple":"gray",v=n?"rgba(128, 0, 128, 0.2)":"rgba(128, 128, 128, 0.2)"):n||(_="gray",v="rgba(128, 128, 128, 0.2)"),e.jsx(P,{variant:"outlined",disabled:S,onClick:()=>R(y),"data-seat-id":y.seatId,"data-status":y.status,"data-seat-type":T,sx:{minWidth:"50px",minHeight:"50px",backgroundColor:v,color:"white",p:.5,fontSize:"0.7rem","&:hover":{backgroundColor:m?"rgba(0, 255, 0, 0.4)":n?"rgba(255,255,255,0.2)":"rgba(128, 128, 128, 0.2)",cursor:n?"pointer":"not-allowed"},"&.Mui-disabled":{backgroundColor:v,color:"white",opacity:!n&&!C&&!d?.5:1}},children:e.jsxs(h,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(A,{sx:{color:_}}),e.jsxs(p,{variant:"body2",align:"center",children:[y.seat.atRow,y.seat.atColumn]})]})})},oe=()=>{const{t:y}=W();return e.jsxs(h,{sx:{textAlign:"center",mb:2},children:[e.jsx(h,{sx:{margin:"0 auto",width:"80%",height:"70px",borderTop:"6px solid #fff",borderRadius:"50% 50% 0 0"}}),e.jsx(p,{variant:"h6",sx:{mt:-2,color:"white"},children:y("movie_seat.selection")})]})},ne=({showTimeId:y,selectedSeats:m,setSelectedSeats:n,groupConnected:R,userTickets:C=[]})=>{const{t:d}=W(),{connection:i}=D(),{userDetails:b}=H(),[T,S]=I.useState([]),[_,v]=I.useState(!0),[f,q]=I.useState({}),w=y||sessionStorage.getItem("currentShowTimeId")||"";I.useEffect(()=>{const s={};m.forEach(c=>{const g=T.find(r=>r.seatId===c.id);if(g){const r=g.seat.seatType.seatTypeId;s[r]=(s[r]||0)+1}}),q(s)},[m,T]);const N=(s,c)=>{if(c.length===0)return!0;for(const g of c){const r=s.seat.atRow,u=g.seat.atRow,o=s.seat.atColumn,t=g.seat.atColumn;if(r===u&&Math.abs(o-t)===1)return!0;const a=r.charCodeAt(0),l=u.charCodeAt(0);if(o===t&&Math.abs(a-l)===1)return!0}return!1},B=(s,c)=>{if(m.length<=2)return!1;const g=m.map(a=>c.find(l=>l.seatId===a.id)).filter(Boolean),r=c.find(a=>a.seatId===s.id);if(!r)return!1;const u=g.filter(a=>a.seatId!==r.seatId);if(u.length<=1)return!1;const o=new Set,t=a=>{const l=`${a.seat.atRow}${a.seat.atColumn}`;o.add(l);for(const x of u){const E=`${x.seat.atRow}${x.seat.atColumn}`;if(o.has(E))continue;const $=a.seat.atRow,k=x.seat.atRow,L=a.seat.atColumn,G=x.seat.atColumn,K=$===k&&Math.abs(L-G)===1,U=L===G&&Math.abs($.charCodeAt(0)-k.charCodeAt(0))===1;(K||U)&&t(x)}};return t(u[0]),o.size!==u.length},z=s=>{if(!C||C.length===0)return!0;const c=C.find(r=>r.seatTypeId===s);return c?(f[s]||0)<c.quantity:!1};I.useEffect(()=>{if(!i||!R)return;const s=(u,o)=>{console.log("Seat marked as pending:",u);const t=b==null?void 0:b.userId;o!==t&&(S(a=>a.map(l=>l.seatId===u?{...l,status:1}:l)),n(a=>{const l=a.find(x=>x.id===u);return l?(j.error(`${l.name} ${d("toast.error.seat.someone_selected")}`),a.filter(x=>x.id!==u)):a}))},c=u=>{S(o=>o.map(t=>t.seatId===u?{...t,status:2}:t))},g=(u,o)=>{const t=b==null?void 0:b.userId;o!==t&&S(a=>a.map(l=>l.seatId===u?{...l,status:1}:l))},r=u=>{console.log("Received SeatAvailable event for:",u),S(o=>o.map(t=>t.seatId===u?{...t,status:0}:t)),n(o=>o.filter(t=>t.id!==u))};return i.on("SeatPending",s),i.on("SeatBought",c),i.on("SeatSelected",g),i.on("SeatAvailable",r),()=>{i.off("SeatPending",s),i.off("SeatBought",c),i.off("SeatSelected",g),i.off("SeatAvailable",r)}},[i,R,n]),I.useEffect(()=>{(async()=>{if(i&&m.length>0){const c=b==null?void 0:b.userId,g=m.map(r=>({TicketId:r.ticketId,Version:r.version}));try{await i.invoke("ReleasePendingSeats",g,w,c),n([]),j(d("toast.error.seat.cancel_booking_bc_back"),{position:"top-center"})}catch(r){console.error("Error releasing seats on return:",r)}}})()},[i]),I.useEffect(()=>{w&&(async()=>{var c;try{v(!0);const g=await Q.get(`ticketdetail/showtime/${w}`);(c=g.data)!=null&&c.data?(S(g.data.data),console.log(`Fetched seats: ${JSON.stringify(g.data.data,null,2)}`)):j.error(d("toast.error.seat.infor"))}catch{j.error(d("toast.error.seat.loading_list"))}finally{v(!1)}})()},[w]);const V=I.useCallback(async s=>{if(!i){j.error(d("toast.error.server.connection"));return}if(s.status===1||s.status===2){const o=s.status===1?d("toast.error.seat.selecting"):d("toast.error.seat.bought");j.error(`${s.seat.atRow}${s.seat.atColumn} ${o} ${d("toast.error.seat.by_someone")}`);return}const c=s.seat.seatType.seatTypeId;if(m.some(o=>o.id===s.seatId)){const o=m.find(t=>t.id===s.seatId);if(o&&B(o,T)){j.error(d("toast.error.seat.cannot_deselect_middle"));return}}else{if(!z(c)){j.error(`${d("toast.error.seat.no_more_tickets")} ${c}`);return}if(m.length>0&&!N(s,m.map(o=>T.find(t=>t.seatId===o.id)).filter(Boolean))){j.error(d("toast.error.seat.adjacent_only"));return}if(te(s,m,T)){j.error(d("toast.error.seat.no_single_isolated"));return}}const r=`${s.seat.atRow}${s.seat.atColumn}`,u={id:s.seatId,name:r,version:s.version,ticketId:s.ticketId,roomName:s.seat.roomName,isMine:!0,selectedAt:Date.now()};try{const o=b==null?void 0:b.userId;let t=[...m];const a=m.findIndex(x=>x.ticketId===s.ticketId);a!==-1?m[a].id===s.seatId?t=t.filter(x=>x.ticketId!==s.ticketId):t[a]=u:t.push(u);const l=t.map(x=>({TicketId:x.ticketId,Version:x.version}));console.log("Selecting seat:",r,l,w,o),await i.invoke("SelectSeat",l,w,o),n(x=>{const E=x.find($=>$.ticketId===s.ticketId);return E?E.id===s.seatId?x.filter($=>$.ticketId!==s.ticketId):(j.success(`${d("toast.success.seat.change_from")} ${E.name} ${d("toast.success.seat.change_to")} ${r}`),x.map($=>$.ticketId===s.ticketId?u:$)):(j.success(`${d("toast.success.seat.select")} ${r}`),[...x,u])})}catch(o){j.error(d("toast.error.seat.cannot_selected")),console.error("Error selecting seat:",o)}},[i,m,z,N,B,w,b,d,T]);return _?e.jsx(J,{}):e.jsxs(h,{sx:{color:"white",pb:4,position:"relative"},children:[e.jsx(oe,{}),e.jsx(h,{sx:{display:"flex",justifyContent:"center",alignItems:"center",p:2},children:e.jsx(h,{sx:{maxWidth:600,display:"flex",flexDirection:"column",gap:2},children:Object.entries(T.reduce((s,c)=>(s[c.seat.atRow]||(s[c.seat.atRow]=[]),s[c.seat.atRow].push(c),s),{})).map(([s,c])=>e.jsx(h,{sx:{display:"flex",justifyContent:"center",gap:4},children:c.map(g=>{const r=m.some(o=>o.id===g.seatId&&o.isMine),u=z(g.seat.seatType.seatTypeId)||r;return e.jsx(se,{ticket:g,isSelectedByMe:r,canSelect:u,handleSeatClick:V},g.seatId)})},s))})})]})},fe=()=>{const y=X(),m=Y(),{t:n}=W(),{connection:R,isConnected:C}=D(),{userDetails:d}=H(),i=y.state;if(I.useEffect(()=>{i||(window.history.length>1?m(-1):m("/",{replace:!0}))},[i,m]),!i)return e.jsx(J,{});const{selectedTime:b,selectedDate:T,tickets:S,movieData:_}=i,v=sessionStorage.getItem("currentShowTimeId")||"",[f,q]=I.useState([]),[w,N]=I.useState(null),[B,z]=I.useState(0),V=I.useCallback(()=>{j.error(n("toast.error.seat.remainder")),q([])},[]),s=I.useCallback(o=>{q(t=>{const a=typeof o=="function"?o(t):o;return a.length!==t.length&&(N(Date.now()),z(l=>l+1)),a})},[]),c=()=>{const o={};return S.forEach(t=>{o[t.seatTypeId]={count:0,names:[]}}),f.forEach(t=>{const a=document.querySelector(`[data-seat-id="${t.id}"]`),l=(a==null?void 0:a.getAttribute("data-seat-type"))||"Standard";o[l]&&(o[l].count++,o[l].names.push(t.name))}),f.length===0?e.jsxs(M,{elevation:3,sx:{p:2,mb:3,backgroundColor:"rgba(0,0,0,0.7)",borderRadius:2,border:"1px solid rgba(255,255,255,0.1)"},children:[e.jsx(p,{variant:"subtitle1",sx:{color:"white",fontWeight:"bold",mb:1,borderBottom:"1px solid rgba(255,255,255,0.3)",pb:1},children:n("movie_seat.selection_status","Trạng Thái Chọn Ghế")}),e.jsxs(p,{variant:"body2",sx:{color:"#f44336"},children:[n("movie_seat.select_required","Vui lòng chọn")," ",r," ",n("movie_seat.seats","ghế")]}),e.jsxs(h,{sx:{mt:2,pt:1,borderTop:"1px solid rgba(255,255,255,0.2)"},children:[e.jsxs(p,{variant:"subtitle2",sx:{color:"white",mb:1},children:[n("admin.room_management.existed","Vé Có Sẵn"),":"]}),S.map(t=>e.jsxs(h,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(h,{sx:{display:"flex",alignItems:"center",gap:1},children:e.jsxs(p,{variant:"body2",sx:{color:"white"},children:[t.typeName,":"]})}),e.jsx(p,{variant:"body2",sx:{color:"white",fontWeight:"bold"},children:t.quantity})]},t.seatTypeId))]})]}):e.jsxs(M,{elevation:3,sx:{p:2,mb:3,backgroundColor:"rgba(0,0,0,0.7)",borderRadius:2,border:"1px solid rgba(255,255,255,0.1)"},children:[e.jsxs(p,{variant:"subtitle1",sx:{color:"white",fontWeight:"bold",mb:1,borderBottom:"1px solid rgba(255,255,255,0.3)",pb:1},children:[n("movie_seat.seat_selected","Ghế Đã Chọn")," (",f.length,"/",r,")"]}),S.map(t=>{const a=o[t.seatTypeId]||{count:0,names:[]},l=a.count===t.quantity;return e.jsxs(h,{sx:{mb:1.5},children:[e.jsxs(h,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(h,{sx:{display:"flex",alignItems:"center",gap:1},children:e.jsxs(p,{variant:"body2",sx:{color:"white"},children:[t.typeName,":"]})}),e.jsxs(p,{variant:"body2",sx:{color:l?"lightgreen":"white",fontWeight:l?"bold":"normal"},children:[a.count,"/",t.quantity]})]}),a.names.length>0&&e.jsx(h,{sx:{pl:4,mb:.5},children:e.jsx(p,{variant:"caption",sx:{color:"rgba(255,255,255,0.7)"},children:a.names.join(", ")})}),a.count<t.quantity&&e.jsx(h,{sx:{pl:4},children:e.jsxs(p,{variant:"caption",sx:{color:"#f44336"},children:[n("movie_seat.still","Còn")," ",t.quantity-a.count," ",n("movie_seat.seat_need_select","ghế cần chọn")]})})]},t.seatTypeId)})]})},g=()=>e.jsxs(M,{elevation:3,sx:{p:2,mb:3,backgroundColor:"rgba(0,0,0,0.7)",borderRadius:2,border:"1px solid rgba(255,255,255,0.1)"},children:[e.jsx(p,{variant:"subtitle1",sx:{color:"white",fontWeight:"bold",mb:1,borderBottom:"1px solid rgba(255,255,255,0.3)",pb:1},children:n("movie_seat.seat_notes","Chú Thích Ghế")}),e.jsxs(h,{sx:{display:"grid",gridTemplateColumns:"auto 1fr",gap:1.5,alignItems:"center"},children:[e.jsx(A,{sx:{color:"white",fontSize:22}}),e.jsx(p,{variant:"body2",sx:{color:"white"},children:n("movie_seat.seat.empty","Ghế Trống")}),e.jsx(A,{sx:{color:"green",fontSize:22}}),e.jsx(p,{variant:"body2",sx:{color:"white"},children:n("movie_seat.seat.selecting","Đang Chọn")}),e.jsx(A,{sx:{color:"yellow",fontSize:22}}),e.jsx(p,{variant:"body2",sx:{color:"white"},children:n("movie_seat.seat.pending","Đang Thanh Toán")}),e.jsx(A,{sx:{color:"red",fontSize:22}}),e.jsx(p,{variant:"body2",sx:{color:"white"},children:n("movie_seat.seat.booked","Đã Đặt")}),e.jsx(h,{sx:{height:1,backgroundColor:"rgba(255,255,255,0.3)",my:1,gridColumn:"1 / span 2"}}),e.jsx(A,{sx:{color:"blue",fontSize:22}}),e.jsx(p,{variant:"body2",sx:{color:"white"},children:n("movie_seat.seat.vip","Ghế VIP")}),e.jsx(A,{sx:{color:"purple",fontSize:22}}),e.jsx(p,{variant:"body2",sx:{color:"white"},children:n("movie_seat.seat.couple","Ghế Couple")}),e.jsx(A,{sx:{color:"gray",fontSize:22}}),e.jsx(p,{variant:"body2",sx:{color:"white"},children:n("movie_seat.seat.unavailable","Không Thể Chọn")})]})]}),r=(S||[]).reduce((o,t)=>o+(t.quantity||0),0);I.useEffect(()=>{r===0&&m("/"),console.log(`State received: ${JSON.stringify(y.state,null,2)}`)},[]),I.useEffect(()=>{f.length===0&&N(null)},[f]);const u=async()=>{if(f.length!==r){j.error(`${n("toast.error.seat.max_selection")} ${r}`);return}if(!R){j.error(n("toast.error.server.connection"));return}try{const o=d==null?void 0:d.userId,t=f.filter(l=>{const x=document.querySelector(`[data-seat-id="${l.id}"]`);return(x==null?void 0:x.getAttribute("data-status"))==="1"||(x==null?void 0:x.getAttribute("data-status"))==="2"});if(t.length>0){const l=t.map(x=>x.name).join(", ");j.error(`${l} ${n("toast.error.seat.someone_selected")}`);return}const a=f.map(l=>({TicketId:l.ticketId,Version:l.version}));await R.invoke("SetSeatPending",a,v,o),j.success(n("toast.success.change_direct.payment")),m("/ticket/payment",{state:{selectedDate:T,selectedTime:b,tickets:S,seats:f.map(l=>l.name),selectedSeatsInfo:f,showTimeId:v,lastSelectionTime:w,resetCounter:B,movieData:_,roomName:f[0].roomName}})}catch(o){console.error("Error when booking:",o),j.error(n("toast.error.seat.cannot_selected"))}};return e.jsx(ee,{children:e.jsx(Z,{maxWidth:"xl",sx:{pb:{xs:4,sm:6,md:8},position:"relative"},children:e.jsxs(h,{sx:{display:"flex",gap:{xs:2,sm:3,md:4},position:"relative",minHeight:"100vh"},children:[e.jsxs(h,{sx:{display:{xs:"none",md:"flex"},position:"sticky",mt:{xs:2,sm:3,md:4},top:{xs:"150px",sm:"150px",md:"150px"},height:"fit-content",width:"250px",backgroundColor:"transparent",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:3,flexShrink:0},children:[f.length>0&&w&&e.jsx(h,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:3},children:e.jsx(O,{seatId:"all-seats",seatName:`${f.length} ${n("seat")}`,startTime:w,resetTrigger:B,onTimeout:V})}),c(),g()]}),e.jsxs(h,{sx:{flex:1},children:[e.jsx(h,{sx:{display:{xs:"block",md:"none"},mb:2},children:e.jsx(F,{currentStep:2})}),f.length>0&&w&&e.jsx(h,{sx:{display:{xs:"block",md:"none"},mb:3},children:e.jsxs(M,{elevation:3,sx:{p:2,color:"white",borderRadius:2,backgroundColor:"rgba(0,0,0,0.7)"},children:[e.jsx(p,{variant:"subtitle2",sx:{mb:2},children:n("movie_seat.timer")}),e.jsx(h,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:e.jsx(O,{seatId:"all-seats-mobile",seatName:`${f.length} ghế`,startTime:w,resetTrigger:B,onTimeout:V})})]})}),e.jsxs(h,{sx:{display:{xs:"block",md:"none"},mb:2},children:[c(),g()]}),e.jsxs(h,{sx:{mt:2},children:[e.jsx(p,{variant:"h4",fontWeight:"bold",gutterBottom:!0,align:"center",fontFamily:"JetBrains Mono",sx:{textTransform:"uppercase",mb:4},children:n("seat_cinema.screening")}),e.jsx(h,{sx:{borderRadius:2,p:3,mb:4},children:e.jsx(ne,{userTickets:S,showTimeId:v,selectedSeats:f,setSelectedSeats:s,groupConnected:C})})]}),f.length>0&&e.jsxs(h,{sx:{position:"fixed",bottom:0,left:0,right:0,p:2,backgroundColor:"rgba(0,0,0,0.8)",display:{xs:"flex",md:"none"},justifyContent:"space-between",alignItems:"center",zIndex:10,borderTop:"1px solid rgba(255,255,255,0.1)"},children:[e.jsxs(p,{variant:"body2",sx:{color:"white"},children:[f.length,"/",r," ",n("movie_seat.seat_selected","đã chọn")]}),e.jsx(P,{variant:"contained",color:"primary",onClick:u,disabled:f.length!==r,sx:{fontSize:"0.9rem",backgroundColor:f.length===r?"#4CAF50":void 0},children:n("movie_seat.continue")})]}),f.length>0&&e.jsxs(h,{sx:{p:2,display:{xs:"none",md:"flex"},justifyContent:"space-between",alignItems:"center",zIndex:10,borderTop:"1px solid rgba(255,255,255,0.1)"},children:[e.jsxs(p,{variant:"body2",sx:{color:"white"},children:[f.length,"/",r," ",n("movie_seat.seat_selected","đã chọn")]}),e.jsx(P,{variant:"contained",color:"primary",onClick:u,disabled:f.length!==r,sx:{px:4,py:1,fontSize:"1rem",borderRadius:2,backgroundColor:f.length===r?"#4CAF50":void 0,"&:hover":{backgroundColor:f.length===r?"#388E3C":void 0}},children:n("movie_seat.continue")})]})]}),e.jsx(h,{sx:{display:{xs:"none",md:"block"},position:"sticky",top:"100px",alignSelf:"flex-start",height:"fit-content",width:"250px",flexShrink:0},children:e.jsx(F,{currentStep:2})})]})})})};export{fe as default};
