import{a as V,a6 as M,g as q,r as S,j as e,L,B as m,T as C,b as H,V as h,e as O,a7 as D,u as W,H as z,C as F,x as k,i as J}from"./index-hKNTF3Dt.js";import{E as U}from"./EventSeat-D8WPZciz.js";import{S as E}from"./StepTracker-DyH1Dzjh.js";import{S as P}from"./SeatCountdown-B8YyVw9h.js";import"./Stepper-CaQAbKv1.js";import"./CancelOutlined-D66xQn3i.js";import"./CheckCircleOutline-Vcbsfvx0.js";import"./AccessTime-DIQ3aLeV.js";const G=({showTimeId:A,selectedSeats:j,setSelectedSeats:g,groupConnected:$,selectedSeatType:_})=>{const{t:d}=V(),{connection:x}=M(),{userDetails:p}=q(),[B,w]=S.useState([]),[R,N]=S.useState(!0),I=A||sessionStorage.getItem("currentShowTimeId")||"";S.useEffect(()=>{if(!x||!$)return;const t=(i,u)=>{console.log("Seat marked as pending:",i);const c=p==null?void 0:p.userId;u!==c&&(w(o=>o.map(n=>n.seatId===i?{...n,status:1}:n)),g(o=>{const n=o.find(a=>a.id===i);return n?(h.error(`${n.name} ${d("toast.error.seat.someone_selected")}`),o.filter(a=>a.id!==i)):o}))},r=i=>{w(u=>u.map(c=>c.seatId===i?{...c,status:2}:c))},s=(i,u)=>{const c=p==null?void 0:p.userId;u!==c&&w(o=>o.map(n=>n.seatId===i?{...n,status:1}:n))},l=i=>{console.log("Received SeatAvailable event for:",i),w(u=>u.map(c=>c.seatId===i?{...c,status:0}:c)),g(u=>u.filter(c=>c.id!==i))};return x.on("SeatPending",t),x.on("SeatBought",r),x.on("SeatSelected",s),x.on("SeatAvailable",l),()=>{x.off("SeatPending",t),x.off("SeatBought",r),x.off("SeatSelected",s),x.off("SeatAvailable",l)}},[x,$,g]),S.useEffect(()=>{(async()=>{if(x&&j.length>0){const r=p==null?void 0:p.userId,s=j.map(l=>({TicketId:l.ticketId,Version:l.version}));try{await x.invoke("ReleasePendingSeats",s,I,r),g([]),h(d("toast.error.seat.cancel_booking_bc_back"),{position:"top-center"})}catch(l){console.error("Error releasing seats on return:",l)}}})()},[x]),S.useEffect(()=>{I&&(async()=>{var r;try{N(!0);const s=await O.get(`ticketdetail/showtime/${I}`);(r=s.data)!=null&&r.data?(w(s.data.data),console.log(`Fetched seats: ${JSON.stringify(s.data.data,null,2)}`)):h.error(d("toast.error.seat.infor"))}catch{h.error(d("toast.error.seat.loading_list"))}finally{N(!1)}})()},[I]);const f=async t=>{if(!x){h.error(d("toast.error.server.connection"));return}if(t.status===1||t.status===2){const l=t.status===1?d("toast.error.seat.selecting"):d("toast.error.seat.bought");h.error(`${t.seat.atRow}${t.seat.atColumn} ${l} ${d("toast.error.seat.by_someone")}`);return}const r=`${t.seat.atRow}${t.seat.atColumn}`,s={id:t.seatId,name:r,version:t.version,ticketId:t.ticketId,roomName:t.seat.roomName,isMine:!0,selectedAt:Date.now()};try{const l=p==null?void 0:p.userId;let i=[...j];const u=j.findIndex(o=>o.ticketId===t.ticketId);u!==-1?j[u].id===t.seatId?i=i.filter(o=>o.ticketId!==t.ticketId):i[u]=s:i.push(s);const c=i.map(o=>({TicketId:o.ticketId,Version:o.version}));console.log("Selecting seat:",r,c,I,l),await x.invoke("SelectSeat",c,I,l),g(o=>{const n=o.find(a=>a.ticketId===t.ticketId);return n?n.id===t.seatId?(h.error(`${d("toast.error.seat.cancel_select")} ${r}`),o.filter(a=>a.ticketId!==t.ticketId)):(h.success(`${d("toast.success.seat.change_from")} ${n.name} ${d("toast.success.seat.change_to")} ${r}`),o.map(a=>a.ticketId===t.ticketId?s:a)):(h.success(`${d("toast.success.seat.select")} ${r}`),[...o,s])})}catch(l){h.error(d("toast.error.seat.cannot_selected")),console.error("Error selecting seat:",l)}};return R?e.jsx(L,{}):e.jsxs(m,{sx:{backgroundColor:"#0B0D1A",color:"white",pb:4,position:"relative"},children:[e.jsxs(m,{sx:{textAlign:"center",mb:2},children:[e.jsx(m,{sx:{margin:"0 auto",width:"80%",height:"70px",borderTop:"6px solid #fff",borderRadius:"50% 50% 0 0"}}),e.jsx(C,{variant:"h6",sx:{mt:-2,color:"white"},children:d("movie_seat.selection")})]}),e.jsx(m,{sx:{display:"flex",justifyContent:"center",alignItems:"center",p:2},children:e.jsx(m,{sx:{maxWidth:600,display:"flex",flexDirection:"column",gap:2},children:Object.entries(B.reduce((t,r)=>(t[r.seat.atRow]||(t[r.seat.atRow]=[]),t[r.seat.atRow].push(r),t),{})).map(([t,r])=>e.jsx(m,{sx:{display:"flex",justifyContent:"center",gap:4},children:r.map(s=>{const l=j.some(T=>T.id===s.seatId&&T.isMine),i=s.status===1,u=s.status===2,c=s.seat.seatType.typeName==="VIP",o=s.seat.seatType.typeName==="Couple";let n="white",a="transparent",b=!1;return l?(n="green",a="rgba(0, 255, 0, 0.2)"):u?(n="red",a="rgba(255, 0, 0, 0.2)",b=!0):c?(n="blue",a="rgba(0, 0, 255, 0.2)"):o?(n="purple",a="rgba(128, 0, 128, 0.2)"):i&&(n="yellow",a="rgba(255, 255, 0, 0.2)",b=!0),_&&s.seat.seatType.typeName!==_&&(b=!0,a="rgba(100, 100, 100, 0.2)"),e.jsx(H,{variant:"outlined",disabled:b,onClick:()=>f(s),"data-seat-id":s.seatId,"data-status":s.status,sx:{minWidth:"50px",minHeight:"50px",backgroundColor:a,color:"white",p:.5,fontSize:"0.7rem","&:hover":{backgroundColor:l?"rgba(0, 255, 0, 0.4)":b?a:"rgba(255,255,255,0.2)"},"&.Mui-disabled":{backgroundColor:a,color:"white"}},children:e.jsxs(m,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(U,{sx:{color:n}}),e.jsxs(C,{variant:"body2",align:"center",children:[s.seat.atRow,s.seat.atColumn]})]})},s.seatId)})},t))})})]})},ae=()=>{const A=D(),j=W(),{t:g}=V(),{connection:$,isConnected:_}=M(),{userDetails:d}=q(),x=A.state,{movieId:p="",selectedTime:B="Not selected",selectedDate:w=new Date().toISOString().split("T")[0],tickets:R=[],movieData:N={}}=x||{},I=sessionStorage.getItem("currentShowTimeId")||"",[f,t]=S.useState([]),[r,s]=S.useState(null),[l,i]=S.useState(0),u=S.useCallback(()=>{h.error(g("toast.error.seat.remainder")),t([])},[]),c=S.useCallback(a=>{t(b=>{const T=typeof a=="function"?a(b):a;return T.length!==b.length&&(s(Date.now()),i(y=>y+1)),T})},[]),o=(R||[]).reduce((a,b)=>a+(b.quantity||0),0);S.useEffect(()=>{f.length===0&&s(null)},[f]);const n=async()=>{if(f.length!==o){h.error(`${g("toast.error.seat.max_selection")} ${o}`);return}if(!$){h.error(g("toast.error.server.connection"));return}try{const a=d==null?void 0:d.userId,b=f.filter(y=>{const v=document.querySelector(`[data-seat-id="${y.id}"]`);return(v==null?void 0:v.getAttribute("data-status"))==="1"||(v==null?void 0:v.getAttribute("data-status"))==="2"});if(b.length>0){const y=b.map(v=>v.name).join(", ");h.error(`${y} ${g("toast.error.seat.someone_selected")}`);return}const T=f.map(y=>({TicketId:y.ticketId,Version:y.version}));await $.invoke("SetSeatPending",T,I,a),h.success(g("toast.success.change_direct.payment")),j("/ticket/payment",{state:{movieId:p,selectedDate:w,selectedTime:B,tickets:R,seats:f.map(y=>y.name),selectedSeatsInfo:f,showTimeId:I,lastSelectionTime:r,resetCounter:l,movieData:N,roomName:f[0].roomName}})}catch(a){console.error("Error when booking:",a),h.error(g("toast.error.seat.cannot_selected"))}};return e.jsxs(m,{sx:{minHeight:"100vh",background:`linear-gradient(to bottom,
          rgba(11, 13, 26, 0.95) 0%,
          rgba(11, 13, 26, 0.85) 100%
        )`,position:"relative","&::before":{content:'""',position:"fixed",top:0,left:0,right:0,bottom:0,background:`radial-gradient(circle at 20% 30%, rgba(78, 46, 131, 0.4) 0%, rgba(78, 46, 131, 0) 50%),
                      radial-gradient(circle at 75% 15%, rgba(33, 64, 154, 0.4) 0%, rgba(33, 64, 154, 0) 50%),
                      linear-gradient(135deg, #0B0D1A 0%, #1A1E3C 50%, #3A1155 100%)`,zIndex:-1}},children:[e.jsx(z,{}),e.jsx(F,{maxWidth:"xl",sx:{pt:{xs:"64px",sm:"72px",md:"80px"},pb:{xs:4,sm:6,md:8},px:{xs:2,sm:3,md:4},position:"relative"},children:e.jsxs(m,{sx:{display:"flex",gap:{xs:2,sm:3,md:4},color:"white",position:"relative",minHeight:"100vh"},children:[e.jsxs(m,{sx:{display:{xs:"none",md:"block"},position:"sticky",top:"100px",alignSelf:"flex-start",height:"fit-content",width:"250px",flexShrink:0},children:[f.length>0&&r&&e.jsxs(k,{elevation:3,sx:{p:3,backgroundColor:"rgba(27, 38, 53, 0.7)",color:"white",borderRadius:2},children:[e.jsx(C,{variant:"subtitle1",sx:{mb:2},children:g("movie_seat.timer")}),e.jsx(m,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:e.jsx(P,{seatId:"all-seats",seatName:`${f.length} ghế`,startTime:r,resetTrigger:l,onTimeout:u})})]}),e.jsx(E,{currentStep:2})]}),e.jsxs(m,{sx:{flex:1,display:"flex",flexDirection:"column",gap:{xs:2,sm:3,md:4},pb:4},children:[e.jsx(m,{sx:{display:{xs:"block",md:"none"},mb:2},children:e.jsx(E,{currentStep:2})}),e.jsxs(m,{sx:{mt:2},children:[e.jsx(C,{variant:"h4",fontWeight:"bold",gutterBottom:!0,align:"center",fontFamily:"JetBrains Mono",sx:{textTransform:"uppercase",mb:4},children:g("seat_cinema.screening")}),f.length>0&&r&&e.jsx(m,{sx:{display:{xs:"block",md:"none"},mb:3},children:e.jsxs(k,{elevation:3,sx:{p:2,backgroundColor:"rgba(27, 38, 53, 0.7)",color:"white",borderRadius:2},children:[e.jsx(C,{variant:"subtitle2",sx:{mb:2},children:g("movie_seat.timer")}),e.jsx(m,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:e.jsx(P,{seatId:"all-seats-mobile",seatName:`${f.length} ghế`,startTime:r,resetTrigger:l,onTimeout:u})})]})}),e.jsxs(m,{sx:{backgroundColor:"rgba(11, 13, 26, 0.6)",borderRadius:2,p:3,mb:4,boxShadow:"0px 4px 20px rgba(0, 0, 0, 0.25)"},children:[e.jsx(G,{showTimeId:I,selectedSeats:f,setSelectedSeats:c,groupConnected:_,seatTypeName:R}),e.jsx(C,{variant:"body2",sx:{mt:2,textAlign:"center",color:"primary.light"},children:`Bạn cần chọn đúng ${o} ghế.`})]}),e.jsx(m,{sx:{display:"flex",justifyContent:"center",mt:4},children:e.jsx(H,{variant:"contained",color:"primary",onClick:n,sx:{px:4,py:1,fontSize:"1rem",borderRadius:2},children:g("movie_seat.continue")})})]})]})]})}),e.jsx(J,{})]})};export{ae as default};
