import{u as L,a6 as K,a as Q,an as Z,r as d,j as e,Z as O,_ as U,B as l,$ as V,a0 as J,a1 as M,a2 as X,a3 as ee,C as te,T as c,b as v,ai as ae,aj as se,al as ie,am as oe,F as re,I as ne,S as le,f as de,aH as ce,aI as me,aE as A,e as w}from"./index-C_VwZXF0.js";import{A as he}from"./AdminNowShowingMovies-CLZNC-m2.js";import{D as ge}from"./DateTimePicker-BFaYzTRO.js";import"./Tabs-D3hbOJPW.js";const ve=()=>{var D;const b=L(),g=K(),{t:m}=Q(),k=Z(),[y,j]=d.useState([]),[R,_]=d.useState([]),[I,x]=d.useState(!1),[S,r]=d.useState({text:"",type:""}),[F,p]=d.useState(!1),[W,P]=d.useState(""),[$,E]=d.useState(0),[s,h]=d.useState({movieId:"",roomId:"",startTime:""});d.useEffect(()=>{g.state&&g.state.roomId&&h(t=>({...t,roomId:g.state.roomId}));const a=async()=>{try{const t=await w.get("movie/showing/page/0/size/100");console.log("Movie API Response:",t.data),t.data&&t.data.items?j(t.data.items):Array.isArray(t.data)?j(t.data):t.data&&t.data.data?j(t.data.data):r({text:"Không tìm thấy phim nào đang chiếu",type:"error"})}catch(t){console.error("Failed to fetch movies:",t),r({text:"Không thể tải danh sách phim",type:"error"})}},o=async()=>{try{const t=await w.get("room");t.data.isSuccess?_(t.data.data):r({text:"Failed to load rooms: "+t.data.message,type:"error"})}catch(t){console.error("Failed to fetch rooms:",t),r({text:"Failed to load rooms",type:"error"})}};a(),o()},[g,m]);const q=a=>{a&&h({...s,startTime:a.format("YYYY-MM-DDTHH:mm")})},Y=a=>{const{name:o,value:t}=a.target;h({...s,[o]:t})},z=async()=>{var a,o,t;if(x(!0),r({text:"",type:""}),!s.movieId||!s.roomId||!s.startTime){x(!1),r({text:"Vui lòng điền đầy đủ thông tin lịch chiếu",type:"error"});return}try{const i=y.find(n=>n.movieId===s.movieId);if(!i){x(!1),r({text:"Không tìm thấy thông tin phim đã chọn",type:"error"});return}const u=new Date(s.startTime),N=i.duration||120,B=new Date(u.getTime()+N*6e4),C=n=>n?`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}T${String(n.getHours()).padStart(2,"0")}:${String(n.getMinutes()).padStart(2,"0")}:00.000Z`:"",T={movieId:s.movieId,roomId:s.roomId,startTime:C(u),endTime:C(B)};console.log("Sending payload:",T);const f=await w.post("showtime",T,{headers:{"Content-Type":"application/json",Accept:"application/json"},validateStatus:function(n){return n<500}});console.log("Response:",f),f.data&&f.data.isSuccess?(r({text:"Thời gian chiếu đã được thêm thành công!",type:"success"}),h({movieId:"",roomId:"",startTime:""}),k.invalidateQueries("ThoiGianChieuData"),setTimeout(()=>{b("/admin/ql-thoi-gian-chieu",{state:{refresh:!0,message:"Thời gian chiếu đã được thêm thành công!"}})},1500)):r({text:`Failed to create showtime: ${((a=f.data)==null?void 0:a.message)||"Unknown error"}`,type:"error"})}catch(i){console.error("Error creating showtime:",i),i.response?console.error("Error response:",{data:i.response.data,status:i.response.status,headers:i.response.headers}):i.request&&console.error("Error request:",i.request);const u=((t=(o=i.response)==null?void 0:o.data)==null?void 0:t.message)||i.message||"Failed to create showtime. Please try again.";r({text:u,type:"error"})}finally{x(!1)}},G=()=>{b("/admin/ql-thoi-gian-chieu")},H=a=>{console.log("Selected movie ID:",a);const o=y.find(t=>t.movieId===a);console.log("Selected movie data:",o),o&&(E(o.duration||120),console.log("Setting duration to:",o.duration||120)),P(a),h(t=>({...t,movieId:a})),p(!1)};return e.jsxs(O,{children:[e.jsx(U,{enableColorScheme:!0}),e.jsxs(l,{sx:{display:"flex",height:"100vh"},children:[e.jsx(V,{}),e.jsxs(l,{sx:{flexGrow:1,display:"flex",flexDirection:"column"},children:[e.jsx(J,{}),e.jsx(l,{component:"main",sx:a=>({flexGrow:1,backgroundColor:M(a.palette.background.default,1),overflowY:"auto",px:3,py:2}),children:e.jsxs(X,{spacing:2,alignItems:"center",children:[e.jsx(ee,{}),e.jsxs(te,{sx:{backgroundColor:"#f5f5f5",color:"#000000",py:3},children:[S.text&&e.jsx(c,{color:S.type==="error"?"error":"success",sx:{mt:2},children:S.text}),e.jsxs(l,{sx:{mt:2,display:"flex",gap:2,flexDirection:"row",alignItems:"center"},children:[e.jsx(c,{variant:"subtitle1",sx:{minWidth:100,textAlign:"right",paddingRight:2},children:m("admin.showtime_management.movie_selection")}),e.jsxs(l,{sx:{display:"flex",width:"100%",gap:2},children:[e.jsx(v,{variant:"contained",color:"primary",onClick:()=>p(!0),sx:{flexShrink:0},children:"Chọn phim"}),e.jsx(l,{sx:{flexGrow:1,display:"flex",alignItems:"center",bgcolor:s.movieId?M("#f5f5f5",.8):"transparent",px:2,py:1,borderRadius:1,border:"1px solid",borderColor:s.movieId?"primary.light":"divider"},children:e.jsx(c,{variant:"body1",sx:{fontWeight:s.movieId?"medium":"normal",color:s.movieId?"text.primary":"text.secondary"},children:s.movieId?((D=y.find(a=>a.movieId===s.movieId))==null?void 0:D.movieName)||"Phim đã chọn":"Chưa chọn phim"})})]})]}),e.jsxs(ae,{open:F,onClose:()=>p(!1),maxWidth:"lg",fullWidth:!0,children:[e.jsx(se,{children:"Chọn phim chiếu"}),e.jsx(ie,{dividers:!0,children:e.jsx(he,{onMovieSelect:H,selectedMovieId:W})}),e.jsx(oe,{children:e.jsx(v,{onClick:()=>p(!1),children:"Đóng"})})]}),e.jsxs(l,{sx:{mt:2,display:"flex",gap:2,flexDirection:"row",alignItems:"center"},children:[e.jsx(c,{variant:"subtitle1",sx:{minWidth:100,textAlign:"right",paddingRight:2},children:m("admin.showtime_management.room_selection")}),e.jsxs(re,{fullWidth:!0,variant:"outlined",size:"small",children:[e.jsx(ne,{id:"room-select-label",children:"Phòng"}),e.jsx(le,{labelId:"room-select-label",id:"room-select",name:"roomId",value:s.roomId,onChange:Y,label:"Phòng",children:R.map(a=>e.jsx(de,{value:a.roomId,children:a.roomName||`Phòng ${a.roomId.substring(0,8)}`},a.roomId))})]})]}),e.jsxs(l,{sx:{mt:2,display:"flex",gap:2,flexDirection:"row",alignItems:"center"},children:[e.jsx(c,{variant:"subtitle1",sx:{minWidth:100,textAlign:"right",paddingRight:2},children:m("admin.showtime_management.start_time")}),e.jsx(ce,{dateAdapter:me,children:e.jsx(ge,{value:s.startTime?A(s.startTime):A(),onChange:q,minutesStep:5,views:["year","month","day","hours","minutes"]})}),e.jsxs(c,{children:["Stored value:"," ",s.startTime==null?"null":s.startTime]})]}),s.movieId&&e.jsxs(l,{sx:{mt:2,display:"flex",gap:2,flexDirection:"row",alignItems:"center"},children:[e.jsx(c,{variant:"subtitle1",sx:{minWidth:100,textAlign:"right",paddingRight:2},children:"Thời lượng"}),e.jsxs(c,{variant:"body1",sx:{bgcolor:"#e8f4fd",px:2,py:1,borderRadius:1,border:"1px solid",borderColor:"info.light",color:"text.primary"},children:[$," phút"]})]}),e.jsxs(l,{sx:{mt:3,display:"flex",justifyContent:"center",gap:2},children:[e.jsx(v,{variant:"outlined",color:"primary",size:"large",sx:{minWidth:150},onClick:G,disabled:I,children:m("admin.showtime_management.cancel")}),e.jsx(v,{variant:"contained",color:"primary",size:"large",sx:{minWidth:150},onClick:z,disabled:I,children:m(I?"admin.showtime_management.loading":"admin.showtime_management.add_new")})]})]})]})})]})]})]})};export{ve as default};
