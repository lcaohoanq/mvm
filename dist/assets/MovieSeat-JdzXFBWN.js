import{a as G,a6 as M,g as O,r as S,j as e,L as F,B as c,T as m,b as V,V as f,e as J,a7 as D,u as H,C as U,x as z}from"./index-B0N4umr3.js";import{E as C}from"./EventSeat-DqtIMzW3.js";import{S as W}from"./SeatCountdown-CZgJZVmZ.js";import{S as L}from"./StepTracker-D2zZHPvM.js";import{S as K}from"./ShowTimeLayout-f6J52PpE.js";import"./AccessTime-LRdfy_Jd.js";import"./Stepper-Cnj2KS6U.js";import"./CancelOutlined-C_LdPdKt.js";import"./CheckCircleOutline-D0uz6DH2.js";import"./UserDetailLayout-C7URJvNA.js";const Q=({showTimeId:q,selectedSeats:I,setSelectedSeats:a,groupConnected:N,userTickets:B=[]})=>{const{t:g}=G(),{connection:p}=M(),{userDetails:b}=O(),[v,$]=S.useState([]),[A,d]=S.useState(!0),[E,_]=S.useState({}),T=q||sessionStorage.getItem("currentShowTimeId")||"";S.useEffect(()=>{const t={};I.forEach(u=>{const l=v.find(x=>x.seatId===u.id);if(l){const x=l.seat.seatType.seatTypeId;t[x]=(t[x]||0)+1}}),_(t)},[I,v]);const R=t=>{if(!B||B.length===0)return!0;const u=B.find(x=>x.seatTypeId===t);return u?(E[t]||0)<u.quantity:!1};S.useEffect(()=>{if(!p||!N)return;const t=(r,h)=>{console.log("Seat marked as pending:",r);const o=b==null?void 0:b.userId;h!==o&&($(n=>n.map(i=>i.seatId===r?{...i,status:1}:i)),a(n=>{const i=n.find(s=>s.id===r);return i?(f.error(`${i.name} ${g("toast.error.seat.someone_selected")}`),n.filter(s=>s.id!==r)):n}))},u=r=>{$(h=>h.map(o=>o.seatId===r?{...o,status:2}:o))},l=(r,h)=>{const o=b==null?void 0:b.userId;h!==o&&$(n=>n.map(i=>i.seatId===r?{...i,status:1}:i))},x=r=>{console.log("Received SeatAvailable event for:",r),$(h=>h.map(o=>o.seatId===r?{...o,status:0}:o)),a(h=>h.filter(o=>o.id!==r))};return p.on("SeatPending",t),p.on("SeatBought",u),p.on("SeatSelected",l),p.on("SeatAvailable",x),()=>{p.off("SeatPending",t),p.off("SeatBought",u),p.off("SeatSelected",l),p.off("SeatAvailable",x)}},[p,N,a]),S.useEffect(()=>{(async()=>{if(p&&I.length>0){const u=b==null?void 0:b.userId,l=I.map(x=>({TicketId:x.ticketId,Version:x.version}));try{await p.invoke("ReleasePendingSeats",l,T,u),a([]),f(g("toast.error.seat.cancel_booking_bc_back"),{position:"top-center"})}catch(x){console.error("Error releasing seats on return:",x)}}})()},[p]),S.useEffect(()=>{T&&(async()=>{var u;try{d(!0);const l=await J.get(`ticketdetail/showtime/${T}`);(u=l.data)!=null&&u.data?($(l.data.data),console.log(`Fetched seats: ${JSON.stringify(l.data.data,null,2)}`)):f.error(g("toast.error.seat.infor"))}catch{f.error(g("toast.error.seat.loading_list"))}finally{d(!1)}})()},[T]);const k=async t=>{if(!p){f.error(g("toast.error.server.connection"));return}if(t.status===1||t.status===2){const h=t.status===1?g("toast.error.seat.selecting"):g("toast.error.seat.bought");f.error(`${t.seat.atRow}${t.seat.atColumn} ${h} ${g("toast.error.seat.by_someone")}`);return}const u=t.seat.seatType.seatTypeId;if(!I.some(h=>h.id===t.seatId)&&!R(u)){f.error(`${g("toast.error.seat.no_more_tickets")} ${u}`);return}const x=`${t.seat.atRow}${t.seat.atColumn}`,r={id:t.seatId,name:x,version:t.version,ticketId:t.ticketId,roomName:t.seat.roomName,isMine:!0,selectedAt:Date.now()};try{const h=b==null?void 0:b.userId;let o=[...I];const n=I.findIndex(s=>s.ticketId===t.ticketId);n!==-1?I[n].id===t.seatId?o=o.filter(s=>s.ticketId!==t.ticketId):o[n]=r:o.push(r);const i=o.map(s=>({TicketId:s.ticketId,Version:s.version}));console.log("Selecting seat:",x,i,T,h),await p.invoke("SelectSeat",i,T,h),a(s=>{const y=s.find(j=>j.ticketId===t.ticketId);return y?y.id===t.seatId?s.filter(j=>j.ticketId!==t.ticketId):(f.success(`${g("toast.success.seat.change_from")} ${y.name} ${g("toast.success.seat.change_to")} ${x}`),s.map(j=>j.ticketId===t.ticketId?r:j)):(f.success(`${g("toast.success.seat.select")} ${x}`),[...s,r])})}catch(h){f.error(g("toast.error.seat.cannot_selected")),console.error("Error selecting seat:",h)}};return A?e.jsx(F,{}):e.jsxs(c,{sx:{color:"white",pb:4,position:"relative"},children:[e.jsxs(c,{sx:{textAlign:"center",mb:2},children:[e.jsx(c,{sx:{margin:"0 auto",width:"80%",height:"70px",borderTop:"6px solid #fff",borderRadius:"50% 50% 0 0"}}),e.jsx(m,{variant:"h6",sx:{mt:-2,color:"white"},children:g("movie_seat.selection")})]}),e.jsx(c,{sx:{display:"flex",justifyContent:"center",alignItems:"center",p:2},children:e.jsx(c,{sx:{maxWidth:600,display:"flex",flexDirection:"column",gap:2},children:Object.entries(v.reduce((t,u)=>(t[u.seat.atRow]||(t[u.seat.atRow]=[]),t[u.seat.atRow].push(u),t),{})).map(([t,u])=>e.jsx(c,{sx:{display:"flex",justifyContent:"center",gap:4},children:u.map(l=>{const x=I.some(P=>P.id===l.seatId&&P.isMine),r=l.status===1,h=l.status===2,o=l.seat.seatType.typeName==="VIP",n=l.seat.seatType.typeName==="Couple";l.seat.seatType.typeName;const i=l.seat.seatType.seatTypeId,s=R(i)||x,y=!s||r||h;let j="white",w="transparent";return x?(j="green",w="rgba(0, 255, 0, 0.2)"):h?(j="red",w="rgba(255, 0, 0, 0.2)"):o?(j=s?"blue":"gray",w=s?"rgba(0, 0, 255, 0.2)":"rgba(128, 128, 128, 0.2)"):n?(j="purple",w="rgba(128, 0, 128, 0.2)"):r?(j="yellow",w="rgba(255, 255, 0, 0.2)"):s||(j="gray",w="rgba(128, 128, 128, 0.2)"),e.jsx(V,{variant:"outlined",disabled:y,onClick:()=>k(l),"data-seat-id":l.seatId,"data-status":l.status,"data-seat-type":i,sx:{minWidth:"50px",minHeight:"50px",backgroundColor:w,color:"white",p:.5,fontSize:"0.7rem","&:hover":{backgroundColor:x?"rgba(0, 255, 0, 0.4)":s?"rgba(255,255,255,0.2)":"rgba(128, 128, 128, 0.2)",cursor:s?"pointer":"not-allowed"},"&.Mui-disabled":{backgroundColor:w,color:"white",opacity:!s&&!r&&!h?.5:1}},children:e.jsxs(c,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(C,{sx:{color:j}}),e.jsxs(m,{variant:"body2",align:"center",children:[l.seat.atRow,l.seat.atColumn]})]})},l.seatId)})},t))})})]})},ie=()=>{const q=D(),I=H(),{t:a}=G(),{connection:N,isConnected:B}=M(),{userDetails:g}=O(),{selectedTime:p,selectedDate:b,tickets:v,movieData:$}=q.state,A=sessionStorage.getItem("currentShowTimeId")||"",[d,E]=S.useState([]),[_,T]=S.useState(null),[R,k]=S.useState(0),t=S.useCallback(()=>{f.error(a("toast.error.seat.remainder")),E([])},[]),u=S.useCallback(o=>{E(n=>{const i=typeof o=="function"?o(n):o;return i.length!==n.length&&(T(Date.now()),k(s=>s+1)),i})},[]),l=()=>{const o={};return v.forEach(n=>{o[n.seatTypeId]={count:0,names:[]}}),d.forEach(n=>{const i=document.querySelector(`[data-seat-id="${n.id}"]`),s=(i==null?void 0:i.getAttribute("data-seat-type"))||"Standard";o[s]&&(o[s].count++,o[s].names.push(n.name))}),d.length===0?e.jsxs(z,{elevation:3,sx:{p:2,mb:3,backgroundColor:"rgba(0,0,0,0.7)",borderRadius:2,border:"1px solid rgba(255,255,255,0.1)"},children:[e.jsx(m,{variant:"subtitle1",sx:{color:"white",fontWeight:"bold",mb:1,borderBottom:"1px solid rgba(255,255,255,0.3)",pb:1},children:a("seat.selection_status","Trạng Thái Chọn Ghế")}),e.jsxs(m,{variant:"body2",sx:{color:"#f44336"},children:[a("seat.select_required","Vui lòng chọn")," ",r," ",a("seat.seats","ghế")]}),e.jsxs(c,{sx:{mt:2,pt:1,borderTop:"1px solid rgba(255,255,255,0.2)"},children:[e.jsxs(m,{variant:"subtitle2",sx:{color:"white",mb:1},children:[a("ticket.available","Vé Có Sẵn"),":"]}),v.map(n=>e.jsxs(c,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(c,{sx:{display:"flex",alignItems:"center",gap:1},children:e.jsxs(m,{variant:"body2",sx:{color:"white"},children:[n.typeName,":"]})}),e.jsx(m,{variant:"body2",sx:{color:"white",fontWeight:"bold"},children:n.quantity})]},n.seatTypeId))]})]}):e.jsxs(z,{elevation:3,sx:{p:2,mb:3,backgroundColor:"rgba(0,0,0,0.7)",borderRadius:2,border:"1px solid rgba(255,255,255,0.1)"},children:[e.jsxs(m,{variant:"subtitle1",sx:{color:"white",fontWeight:"bold",mb:1,borderBottom:"1px solid rgba(255,255,255,0.3)",pb:1},children:[a("seat.selected_summary","Ghế Đã Chọn")," (",d.length,"/",r,")"]}),v.map(n=>{const i=o[n.seatTypeId]||{count:0,names:[]},s=i.count===n.quantity;return e.jsxs(c,{sx:{mb:1.5},children:[e.jsxs(c,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(c,{sx:{display:"flex",alignItems:"center",gap:1},children:e.jsxs(m,{variant:"body2",sx:{color:"white"},children:[n.typeName,":"]})}),e.jsxs(m,{variant:"body2",sx:{color:s?"lightgreen":"white",fontWeight:s?"bold":"normal"},children:[i.count,"/",n.quantity]})]}),i.names.length>0&&e.jsx(c,{sx:{pl:4,mb:.5},children:e.jsx(m,{variant:"caption",sx:{color:"rgba(255,255,255,0.7)"},children:i.names.join(", ")})}),i.count<n.quantity&&e.jsx(c,{sx:{pl:4},children:e.jsxs(m,{variant:"caption",sx:{color:"#f44336"},children:[a("seat.remaining_type","Còn")," ",n.quantity-i.count," ",a("seat.to_select_type","ghế cần chọn")]})})]},n.seatTypeId)})]})},x=()=>e.jsxs(z,{elevation:3,sx:{p:2,mb:3,backgroundColor:"rgba(0,0,0,0.7)",borderRadius:2,border:"1px solid rgba(255,255,255,0.1)"},children:[e.jsx(m,{variant:"subtitle1",sx:{color:"white",fontWeight:"bold",mb:1,borderBottom:"1px solid rgba(255,255,255,0.3)",pb:1},children:a("seat.legend","Chú Thích Ghế")}),e.jsxs(c,{sx:{display:"grid",gridTemplateColumns:"auto 1fr",gap:1.5,alignItems:"center"},children:[e.jsx(C,{sx:{color:"white",fontSize:22}}),e.jsx(m,{variant:"body2",sx:{color:"white"},children:a("seat.available","Ghế Trống")}),e.jsx(C,{sx:{color:"green",fontSize:22}}),e.jsx(m,{variant:"body2",sx:{color:"white"},children:a("seat.selected","Đang Chọn")}),e.jsx(C,{sx:{color:"yellow",fontSize:22}}),e.jsx(m,{variant:"body2",sx:{color:"white"},children:a("seat.pending","Đang Thanh Toán")}),e.jsx(C,{sx:{color:"red",fontSize:22}}),e.jsx(m,{variant:"body2",sx:{color:"white"},children:a("seat.booked","Đã Đặt")}),e.jsx(c,{sx:{height:1,backgroundColor:"rgba(255,255,255,0.3)",my:1,gridColumn:"1 / span 2"}}),e.jsx(C,{sx:{color:"blue",fontSize:22}}),e.jsx(m,{variant:"body2",sx:{color:"white"},children:a("seat.vip","Ghế VIP")}),e.jsx(C,{sx:{color:"purple",fontSize:22}}),e.jsx(m,{variant:"body2",sx:{color:"white"},children:a("seat.couple","Ghế Couple")}),e.jsx(C,{sx:{color:"gray",fontSize:22}}),e.jsx(m,{variant:"body2",sx:{color:"white"},children:a("seat.unavailable","Không Thể Chọn")})]})]}),r=(v||[]).reduce((o,n)=>o+(n.quantity||0),0);S.useEffect(()=>{r===0&&I("/"),console.log(`State received: ${JSON.stringify(q.state,null,2)}`)},[]),S.useEffect(()=>{d.length===0&&T(null)},[d]);const h=async()=>{if(d.length!==r){f.error(`${a("toast.error.seat.max_selection")} ${r}`);return}if(!N){f.error(a("toast.error.server.connection"));return}try{const o=g==null?void 0:g.userId,n=d.filter(s=>{const y=document.querySelector(`[data-seat-id="${s.id}"]`);return(y==null?void 0:y.getAttribute("data-status"))==="1"||(y==null?void 0:y.getAttribute("data-status"))==="2"});if(n.length>0){const s=n.map(y=>y.name).join(", ");f.error(`${s} ${a("toast.error.seat.someone_selected")}`);return}const i=d.map(s=>({TicketId:s.ticketId,Version:s.version}));await N.invoke("SetSeatPending",i,A,o),f.success(a("toast.success.change_direct.payment")),I("/ticket/payment",{state:{selectedDate:b,selectedTime:p,tickets:v,seats:d.map(s=>s.name),selectedSeatsInfo:d,showTimeId:A,lastSelectionTime:_,resetCounter:R,movieData:$,roomName:d[0].roomName}})}catch(o){console.error("Error when booking:",o),f.error(a("toast.error.seat.cannot_selected"))}};return e.jsx(K,{children:e.jsx(U,{maxWidth:"xl",sx:{pb:{xs:4,sm:6,md:8},position:"relative"},children:e.jsxs(c,{sx:{display:"flex",gap:{xs:2,sm:3,md:4},position:"relative",minHeight:"100vh"},children:[e.jsxs(c,{sx:{display:{xs:"none",md:"flex"},position:"sticky",mt:{xs:2,sm:3,md:4},top:{xs:"150px",sm:"150px",md:"150px"},height:"fit-content",width:"250px",backgroundColor:"transparent",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:3,flexShrink:0},children:[d.length>0&&_&&e.jsx(c,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:3},children:e.jsx(W,{seatId:"all-seats",seatName:`${d.length} ghế`,startTime:_,resetTrigger:R,onTimeout:t})}),l(),x()]}),e.jsxs(c,{sx:{flex:1},children:[e.jsx(c,{sx:{display:{xs:"block",md:"none"},mb:2},children:e.jsx(L,{currentStep:2})}),d.length>0&&_&&e.jsx(c,{sx:{display:{xs:"block",md:"none"},mb:3},children:e.jsxs(z,{elevation:3,sx:{p:2,color:"white",borderRadius:2,backgroundColor:"rgba(0,0,0,0.7)"},children:[e.jsx(m,{variant:"subtitle2",sx:{mb:2},children:a("movie_seat.timer")}),e.jsx(c,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:e.jsx(W,{seatId:"all-seats-mobile",seatName:`${d.length} ghế`,startTime:_,resetTrigger:R,onTimeout:t})})]})}),e.jsxs(c,{sx:{display:{xs:"block",md:"none"},mb:2},children:[l(),x()]}),e.jsxs(c,{sx:{mt:2},children:[e.jsx(m,{variant:"h4",fontWeight:"bold",gutterBottom:!0,align:"center",fontFamily:"JetBrains Mono",sx:{textTransform:"uppercase",mb:4},children:a("seat_cinema.screening")}),e.jsx(c,{sx:{borderRadius:2,p:3,mb:4},children:e.jsx(Q,{userTickets:v,showTimeId:A,selectedSeats:d,setSelectedSeats:u,groupConnected:B})})]}),d.length>0&&e.jsxs(c,{sx:{position:"fixed",bottom:0,left:0,right:0,p:2,backgroundColor:"rgba(0,0,0,0.8)",display:{xs:"flex",md:"none"},justifyContent:"space-between",alignItems:"center",zIndex:10,borderTop:"1px solid rgba(255,255,255,0.1)"},children:[e.jsxs(m,{variant:"body2",sx:{color:"white"},children:[d.length,"/",r," ",a("seat.selected","đã chọn")]}),e.jsx(V,{variant:"contained",color:"primary",onClick:h,disabled:d.length!==r,sx:{fontSize:"0.9rem",backgroundColor:d.length===r?"#4CAF50":void 0},children:a("movie_seat.continue")})]}),d.length>0&&e.jsxs(c,{sx:{p:2,display:{xs:"none",md:"flex"},justifyContent:"space-between",alignItems:"center",zIndex:10,borderTop:"1px solid rgba(255,255,255,0.1)"},children:[e.jsxs(m,{variant:"body2",sx:{color:"white"},children:[d.length,"/",r," ",a("seat.selected","đã chọn")]}),e.jsx(V,{variant:"contained",color:"primary",onClick:h,disabled:d.length!==r,sx:{px:4,py:1,fontSize:"1rem",borderRadius:2,backgroundColor:d.length===r?"#4CAF50":void 0,"&:hover":{backgroundColor:d.length===r?"#388E3C":void 0}},children:a("movie_seat.continue")})]})]}),e.jsx(c,{sx:{display:{xs:"none",md:"block"},position:"sticky",top:"100px",alignSelf:"flex-start",height:"fit-content",width:"250px",flexShrink:0},children:e.jsx(L,{currentStep:2})})]})})})};export{ie as default};
