import{a as G,a6 as M,g as O,r as S,j as e,L as F,B as i,T as m,b as V,V as y,e as J,a7 as D,u as H,C as U,x as z}from"./index-DGSIee42.js";import{E as C}from"./EventSeat-CXQpn_oI.js";import{S as W}from"./SeatCountdown-BwuPxaKR.js";import{S as L}from"./StepTracker-Chj8rDEF.js";import{S as K}from"./ShowTimeLayout-5BiqXduQ.js";import"./AccessTime-D-B-n3o8.js";import"./Stepper-KXUmC-Tk.js";import"./CancelOutlined-9ssss8DL.js";import"./CheckCircleOutline-B4DINzmg.js";import"./UserDetailLayout-D5rD0lnC.js";const Q=({showTimeId:E,selectedSeats:j,setSelectedSeats:r,groupConnected:_,userTickets:R=[]})=>{const{t:b}=G(),{connection:f}=M(),{userDetails:I}=O(),[N,v]=S.useState([]),[k,$]=S.useState(!0),[c,q]=S.useState({}),w=E||sessionStorage.getItem("currentShowTimeId")||"";S.useEffect(()=>{const t={};j.forEach(x=>{const a=N.find(d=>d.seatId===x.id);if(a){const d=a.seat.seatType.seatTypeId;t[d]=(t[d]||0)+1}}),q(t)},[j,N]);const B=t=>{if(!R||R.length===0)return!0;const x=R.find(d=>d.seatTypeId===t);return x?(c[t]||0)<x.quantity:!1};S.useEffect(()=>{if(!f||!_)return;const t=(h,o)=>{console.log("Seat marked as pending:",h);const u=I==null?void 0:I.userId;o!==u&&(v(l=>l.map(s=>s.seatId===h?{...s,status:1}:s)),r(l=>{const s=l.find(n=>n.id===h);return s?(y.error(`${s.name} ${b("toast.error.seat.someone_selected")}`),l.filter(n=>n.id!==h)):l}))},x=h=>{v(o=>o.map(u=>u.seatId===h?{...u,status:2}:u))},a=(h,o)=>{const u=I==null?void 0:I.userId;o!==u&&v(l=>l.map(s=>s.seatId===h?{...s,status:1}:s))},d=h=>{console.log("Received SeatAvailable event for:",h),v(o=>o.map(u=>u.seatId===h?{...u,status:0}:u)),r(o=>o.filter(u=>u.id!==h))};return f.on("SeatPending",t),f.on("SeatBought",x),f.on("SeatSelected",a),f.on("SeatAvailable",d),()=>{f.off("SeatPending",t),f.off("SeatBought",x),f.off("SeatSelected",a),f.off("SeatAvailable",d)}},[f,_,r]),S.useEffect(()=>{(async()=>{if(f&&j.length>0){const x=I==null?void 0:I.userId,a=j.map(d=>({TicketId:d.ticketId,Version:d.version}));try{await f.invoke("ReleasePendingSeats",a,w,x),r([]),y(b("toast.error.seat.cancel_booking_bc_back"),{position:"top-center"})}catch(d){console.error("Error releasing seats on return:",d)}}})()},[f]),S.useEffect(()=>{w&&(async()=>{var x;try{$(!0);const a=await J.get(`ticketdetail/showtime/${w}`);(x=a.data)!=null&&x.data?(v(a.data.data),console.log(`Fetched seats: ${JSON.stringify(a.data.data,null,2)}`)):y.error(b("toast.error.seat.infor"))}catch{y.error(b("toast.error.seat.loading_list"))}finally{$(!1)}})()},[w]);const A=async t=>{if(!f){y.error(b("toast.error.server.connection"));return}if(t.status===1||t.status===2){const o=t.status===1?b("toast.error.seat.selecting"):b("toast.error.seat.bought");y.error(`${t.seat.atRow}${t.seat.atColumn} ${o} ${b("toast.error.seat.by_someone")}`);return}const x=t.seat.seatType.seatTypeId;if(!j.some(o=>o.id===t.seatId)&&!B(x)){y.error(`${b("toast.error.seat.no_more_tickets")} ${x}`);return}const d=`${t.seat.atRow}${t.seat.atColumn}`,h={id:t.seatId,name:d,version:t.version,ticketId:t.ticketId,roomName:t.seat.roomName,isMine:!0,selectedAt:Date.now()};try{const o=I==null?void 0:I.userId;let u=[...j];const l=j.findIndex(n=>n.ticketId===t.ticketId);l!==-1?j[l].id===t.seatId?u=u.filter(n=>n.ticketId!==t.ticketId):u[l]=h:u.push(h);const s=u.map(n=>({TicketId:n.ticketId,Version:n.version}));console.log("Selecting seat:",d,s,w,o),await f.invoke("SelectSeat",s,w,o),r(n=>{const g=n.find(p=>p.ticketId===t.ticketId);return g?g.id===t.seatId?n.filter(p=>p.ticketId!==t.ticketId):(y.success(`${b("toast.success.seat.change_from")} ${g.name} ${b("toast.success.seat.change_to")} ${d}`),n.map(p=>p.ticketId===t.ticketId?h:p)):(y.success(`${b("toast.success.seat.select")} ${d}`),[...n,h])})}catch(o){y.error(b("toast.error.seat.cannot_selected")),console.error("Error selecting seat:",o)}};return k?e.jsx(F,{}):e.jsxs(i,{sx:{color:"white",pb:4,position:"relative"},children:[e.jsxs(i,{sx:{textAlign:"center",mb:2},children:[e.jsx(i,{sx:{margin:"0 auto",width:"80%",height:"70px",borderTop:"6px solid #fff",borderRadius:"50% 50% 0 0"}}),e.jsx(m,{variant:"h6",sx:{mt:-2,color:"white"},children:b("movie_seat.selection")})]}),e.jsx(i,{sx:{display:"flex",justifyContent:"center",alignItems:"center",p:2},children:e.jsx(i,{sx:{maxWidth:600,display:"flex",flexDirection:"column",gap:2},children:Object.entries(N.reduce((t,x)=>(t[x.seat.atRow]||(t[x.seat.atRow]=[]),t[x.seat.atRow].push(x),t),{})).map(([t,x])=>e.jsx(i,{sx:{display:"flex",justifyContent:"center",gap:4},children:x.map(a=>{const d=j.some(P=>P.id===a.seatId&&P.isMine),h=a.status===1,o=a.status===2,u=a.seat.seatType.typeName==="VIP",l=a.seat.seatType.typeName==="Couple";a.seat.seatType.typeName;const s=a.seat.seatType.seatTypeId,n=B(s)||d,g=!n||h||o;let p="white",T="transparent";return d?(p="green",T="rgba(0, 255, 0, 0.2)"):o?(p="red",T="rgba(255, 0, 0, 0.2)"):u?(p=n?"blue":"gray",T=n?"rgba(0, 0, 255, 0.2)":"rgba(128, 128, 128, 0.2)"):l?(p="purple",T="rgba(128, 0, 128, 0.2)"):h?(p="yellow",T="rgba(255, 255, 0, 0.2)"):n||(p="gray",T="rgba(128, 128, 128, 0.2)"),e.jsx(V,{variant:"outlined",disabled:g,onClick:()=>A(a),"data-seat-id":a.seatId,"data-status":a.status,"data-seat-type":s,sx:{minWidth:"50px",minHeight:"50px",backgroundColor:T,color:"white",p:.5,fontSize:"0.7rem","&:hover":{backgroundColor:d?"rgba(0, 255, 0, 0.4)":n?"rgba(255,255,255,0.2)":"rgba(128, 128, 128, 0.2)",cursor:n?"pointer":"not-allowed"},"&.Mui-disabled":{backgroundColor:T,color:"white",opacity:!n&&!h&&!o?.5:1}},children:e.jsxs(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(C,{sx:{color:p}}),e.jsxs(m,{variant:"body2",align:"center",children:[a.seat.atRow,a.seat.atColumn]})]})},a.seatId)})},t))})})]})},ie=()=>{const E=D(),j=H(),{t:r}=G(),{connection:_,isConnected:R}=M(),{userDetails:b}=O(),f=E.state;if(S.useEffect(()=>{f||(window.history.length>1?j(-1):j("/",{replace:!0}))},[f,j]),!f)return e.jsx(F,{});const{selectedTime:I,selectedDate:N,tickets:v,movieData:k}=f,$=sessionStorage.getItem("currentShowTimeId")||"",[c,q]=S.useState([]),[w,B]=S.useState(null),[A,t]=S.useState(0),x=S.useCallback(()=>{y.error(r("toast.error.seat.remainder")),q([])},[]),a=S.useCallback(l=>{q(s=>{const n=typeof l=="function"?l(s):l;return n.length!==s.length&&(B(Date.now()),t(g=>g+1)),n})},[]),d=()=>{const l={};return v.forEach(s=>{l[s.seatTypeId]={count:0,names:[]}}),c.forEach(s=>{const n=document.querySelector(`[data-seat-id="${s.id}"]`),g=(n==null?void 0:n.getAttribute("data-seat-type"))||"Standard";l[g]&&(l[g].count++,l[g].names.push(s.name))}),c.length===0?e.jsxs(z,{elevation:3,sx:{p:2,mb:3,backgroundColor:"rgba(0,0,0,0.7)",borderRadius:2,border:"1px solid rgba(255,255,255,0.1)"},children:[e.jsx(m,{variant:"subtitle1",sx:{color:"white",fontWeight:"bold",mb:1,borderBottom:"1px solid rgba(255,255,255,0.3)",pb:1},children:r("seat.selection_status","Trạng Thái Chọn Ghế")}),e.jsxs(m,{variant:"body2",sx:{color:"#f44336"},children:[r("seat.select_required","Vui lòng chọn")," ",o," ",r("seat.seats","ghế")]}),e.jsxs(i,{sx:{mt:2,pt:1,borderTop:"1px solid rgba(255,255,255,0.2)"},children:[e.jsxs(m,{variant:"subtitle2",sx:{color:"white",mb:1},children:[r("ticket.available","Vé Có Sẵn"),":"]}),v.map(s=>e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(i,{sx:{display:"flex",alignItems:"center",gap:1},children:e.jsxs(m,{variant:"body2",sx:{color:"white"},children:[s.typeName,":"]})}),e.jsx(m,{variant:"body2",sx:{color:"white",fontWeight:"bold"},children:s.quantity})]},s.seatTypeId))]})]}):e.jsxs(z,{elevation:3,sx:{p:2,mb:3,backgroundColor:"rgba(0,0,0,0.7)",borderRadius:2,border:"1px solid rgba(255,255,255,0.1)"},children:[e.jsxs(m,{variant:"subtitle1",sx:{color:"white",fontWeight:"bold",mb:1,borderBottom:"1px solid rgba(255,255,255,0.3)",pb:1},children:[r("seat.selected_summary","Ghế Đã Chọn")," (",c.length,"/",o,")"]}),v.map(s=>{const n=l[s.seatTypeId]||{count:0,names:[]},g=n.count===s.quantity;return e.jsxs(i,{sx:{mb:1.5},children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsx(i,{sx:{display:"flex",alignItems:"center",gap:1},children:e.jsxs(m,{variant:"body2",sx:{color:"white"},children:[s.typeName,":"]})}),e.jsxs(m,{variant:"body2",sx:{color:g?"lightgreen":"white",fontWeight:g?"bold":"normal"},children:[n.count,"/",s.quantity]})]}),n.names.length>0&&e.jsx(i,{sx:{pl:4,mb:.5},children:e.jsx(m,{variant:"caption",sx:{color:"rgba(255,255,255,0.7)"},children:n.names.join(", ")})}),n.count<s.quantity&&e.jsx(i,{sx:{pl:4},children:e.jsxs(m,{variant:"caption",sx:{color:"#f44336"},children:[r("seat.remaining_type","Còn")," ",s.quantity-n.count," ",r("seat.to_select_type","ghế cần chọn")]})})]},s.seatTypeId)})]})},h=()=>e.jsxs(z,{elevation:3,sx:{p:2,mb:3,backgroundColor:"rgba(0,0,0,0.7)",borderRadius:2,border:"1px solid rgba(255,255,255,0.1)"},children:[e.jsx(m,{variant:"subtitle1",sx:{color:"white",fontWeight:"bold",mb:1,borderBottom:"1px solid rgba(255,255,255,0.3)",pb:1},children:r("seat.legend","Chú Thích Ghế")}),e.jsxs(i,{sx:{display:"grid",gridTemplateColumns:"auto 1fr",gap:1.5,alignItems:"center"},children:[e.jsx(C,{sx:{color:"white",fontSize:22}}),e.jsx(m,{variant:"body2",sx:{color:"white"},children:r("seat.available","Ghế Trống")}),e.jsx(C,{sx:{color:"green",fontSize:22}}),e.jsx(m,{variant:"body2",sx:{color:"white"},children:r("seat.selected","Đang Chọn")}),e.jsx(C,{sx:{color:"yellow",fontSize:22}}),e.jsx(m,{variant:"body2",sx:{color:"white"},children:r("seat.pending","Đang Thanh Toán")}),e.jsx(C,{sx:{color:"red",fontSize:22}}),e.jsx(m,{variant:"body2",sx:{color:"white"},children:r("seat.booked","Đã Đặt")}),e.jsx(i,{sx:{height:1,backgroundColor:"rgba(255,255,255,0.3)",my:1,gridColumn:"1 / span 2"}}),e.jsx(C,{sx:{color:"blue",fontSize:22}}),e.jsx(m,{variant:"body2",sx:{color:"white"},children:r("seat.vip","Ghế VIP")}),e.jsx(C,{sx:{color:"purple",fontSize:22}}),e.jsx(m,{variant:"body2",sx:{color:"white"},children:r("seat.couple","Ghế Couple")}),e.jsx(C,{sx:{color:"gray",fontSize:22}}),e.jsx(m,{variant:"body2",sx:{color:"white"},children:r("seat.unavailable","Không Thể Chọn")})]})]}),o=(v||[]).reduce((l,s)=>l+(s.quantity||0),0);S.useEffect(()=>{o===0&&j("/"),console.log(`State received: ${JSON.stringify(E.state,null,2)}`)},[]),S.useEffect(()=>{c.length===0&&B(null)},[c]);const u=async()=>{if(c.length!==o){y.error(`${r("toast.error.seat.max_selection")} ${o}`);return}if(!_){y.error(r("toast.error.server.connection"));return}try{const l=b==null?void 0:b.userId,s=c.filter(g=>{const p=document.querySelector(`[data-seat-id="${g.id}"]`);return(p==null?void 0:p.getAttribute("data-status"))==="1"||(p==null?void 0:p.getAttribute("data-status"))==="2"});if(s.length>0){const g=s.map(p=>p.name).join(", ");y.error(`${g} ${r("toast.error.seat.someone_selected")}`);return}const n=c.map(g=>({TicketId:g.ticketId,Version:g.version}));await _.invoke("SetSeatPending",n,$,l),y.success(r("toast.success.change_direct.payment")),j("/ticket/payment",{state:{selectedDate:N,selectedTime:I,tickets:v,seats:c.map(g=>g.name),selectedSeatsInfo:c,showTimeId:$,lastSelectionTime:w,resetCounter:A,movieData:k,roomName:c[0].roomName}})}catch(l){console.error("Error when booking:",l),y.error(r("toast.error.seat.cannot_selected"))}};return e.jsx(K,{children:e.jsx(U,{maxWidth:"xl",sx:{pb:{xs:4,sm:6,md:8},position:"relative"},children:e.jsxs(i,{sx:{display:"flex",gap:{xs:2,sm:3,md:4},position:"relative",minHeight:"100vh"},children:[e.jsxs(i,{sx:{display:{xs:"none",md:"flex"},position:"sticky",mt:{xs:2,sm:3,md:4},top:{xs:"150px",sm:"150px",md:"150px"},height:"fit-content",width:"250px",backgroundColor:"transparent",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:3,flexShrink:0},children:[c.length>0&&w&&e.jsx(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:3},children:e.jsx(W,{seatId:"all-seats",seatName:`${c.length} ghế`,startTime:w,resetTrigger:A,onTimeout:x})}),d(),h()]}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(i,{sx:{display:{xs:"block",md:"none"},mb:2},children:e.jsx(L,{currentStep:2})}),c.length>0&&w&&e.jsx(i,{sx:{display:{xs:"block",md:"none"},mb:3},children:e.jsxs(z,{elevation:3,sx:{p:2,color:"white",borderRadius:2,backgroundColor:"rgba(0,0,0,0.7)"},children:[e.jsx(m,{variant:"subtitle2",sx:{mb:2},children:r("movie_seat.timer")}),e.jsx(i,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:e.jsx(W,{seatId:"all-seats-mobile",seatName:`${c.length} ghế`,startTime:w,resetTrigger:A,onTimeout:x})})]})}),e.jsxs(i,{sx:{display:{xs:"block",md:"none"},mb:2},children:[d(),h()]}),e.jsxs(i,{sx:{mt:2},children:[e.jsx(m,{variant:"h4",fontWeight:"bold",gutterBottom:!0,align:"center",fontFamily:"JetBrains Mono",sx:{textTransform:"uppercase",mb:4},children:r("seat_cinema.screening")}),e.jsx(i,{sx:{borderRadius:2,p:3,mb:4},children:e.jsx(Q,{userTickets:v,showTimeId:$,selectedSeats:c,setSelectedSeats:a,groupConnected:R})})]}),c.length>0&&e.jsxs(i,{sx:{position:"fixed",bottom:0,left:0,right:0,p:2,backgroundColor:"rgba(0,0,0,0.8)",display:{xs:"flex",md:"none"},justifyContent:"space-between",alignItems:"center",zIndex:10,borderTop:"1px solid rgba(255,255,255,0.1)"},children:[e.jsxs(m,{variant:"body2",sx:{color:"white"},children:[c.length,"/",o," ",r("seat.selected","đã chọn")]}),e.jsx(V,{variant:"contained",color:"primary",onClick:u,disabled:c.length!==o,sx:{fontSize:"0.9rem",backgroundColor:c.length===o?"#4CAF50":void 0},children:r("movie_seat.continue")})]}),c.length>0&&e.jsxs(i,{sx:{p:2,display:{xs:"none",md:"flex"},justifyContent:"space-between",alignItems:"center",zIndex:10,borderTop:"1px solid rgba(255,255,255,0.1)"},children:[e.jsxs(m,{variant:"body2",sx:{color:"white"},children:[c.length,"/",o," ",r("seat.selected","đã chọn")]}),e.jsx(V,{variant:"contained",color:"primary",onClick:u,disabled:c.length!==o,sx:{px:4,py:1,fontSize:"1rem",borderRadius:2,backgroundColor:c.length===o?"#4CAF50":void 0,"&:hover":{backgroundColor:c.length===o?"#388E3C":void 0}},children:r("movie_seat.continue")})]})]}),e.jsx(i,{sx:{display:{xs:"none",md:"block"},position:"sticky",top:"100px",alignSelf:"flex-start",height:"fit-content",width:"250px",flexShrink:0},children:e.jsx(L,{currentStep:2})})]})})})};export{ie as default};
