import{u as K,a7 as L,a as Q,aK as U,r as d,j as e,U as Z,W as O,B as l,X as V,Y as X,Z as M,_ as J,$ as ee,C as te,T as c,b as v,aj as ae,ak as se,am as oe,an as ie,F as re,I as ne,S as le,f as de,aF as ce,aG as me,aD as A,e as w}from"./index-B2eA6uDr.js";import{A as he}from"./AdminNowShowingMovies-6Re2qgAt.js";import{D as ge}from"./DateTimePicker-B_Oa4OBr.js";import"./Tabs-BHJAavFr.js";const ve=()=>{var b;const D=K(),g=L(),{t:m}=Q(),k=U(),[y,j]=d.useState([]),[R,F]=d.useState([]),[I,x]=d.useState(!1),[S,r]=d.useState({text:"",type:""}),[W,p]=d.useState(!1),[_,P]=d.useState(""),[$,Y]=d.useState(0),[s,h]=d.useState({movieId:"",roomId:"",startTime:""});d.useEffect(()=>{g.state&&g.state.roomId&&h(t=>({...t,roomId:g.state.roomId}));const a=async()=>{try{const t=await w.get("movie/showing/page/0/size/100");console.log("Movie API Response:",t.data),t.data&&t.data.items?j(t.data.items):Array.isArray(t.data)?j(t.data):t.data&&t.data.data?j(t.data.data):r({text:"Không tìm thấy phim nào đang chiếu",type:"error"})}catch(t){console.error("Failed to fetch movies:",t),r({text:"Không thể tải danh sách phim",type:"error"})}},i=async()=>{try{const t=await w.get("room");t.data.isSuccess?F(t.data.data):r({text:"Failed to load rooms: "+t.data.message,type:"error"})}catch(t){console.error("Failed to fetch rooms:",t),r({text:"Failed to load rooms",type:"error"})}};a(),i()},[g,m]);const q=a=>{a&&h({...s,startTime:a.format("YYYY-MM-DDTHH:mm")})},E=a=>{const{name:i,value:t}=a.target;h({...s,[i]:t})},G=async()=>{var a,i,t;if(x(!0),r({text:"",type:""}),!s.movieId||!s.roomId||!s.startTime){x(!1),r({text:"Vui lòng điền đầy đủ thông tin lịch chiếu",type:"error"});return}try{const o=y.find(n=>n.movieId===s.movieId);if(!o){x(!1),r({text:"Không tìm thấy thông tin phim đã chọn",type:"error"});return}const u=new Date(s.startTime),B=o.duration||120,H=new Date(u.getTime()+B*6e4),C=n=>n?`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}T${String(n.getHours()).padStart(2,"0")}:${String(n.getMinutes()).padStart(2,"0")}:00.000Z`:"",T={movieId:s.movieId,roomId:s.roomId,startTime:C(u),endTime:C(H)};console.log("Sending payload:",T);const f=await w.post("showtime",T,{headers:{"Content-Type":"application/json",Accept:"application/json"},validateStatus:function(n){return n<500}});console.log("Response:",f),f.data&&f.data.isSuccess?(r({text:"Thời gian chiếu đã được thêm thành công!",type:"success"}),h({movieId:"",roomId:"",startTime:""}),k.invalidateQueries("ThoiGianChieuData"),setTimeout(()=>{D("/admin/ql-thoi-gian-chieu",{state:{refresh:!0,message:"Thời gian chiếu đã được thêm thành công!"}})},1500)):r({text:`Failed to create showtime: ${((a=f.data)==null?void 0:a.message)||"Unknown error"}`,type:"error"})}catch(o){console.error("Error creating showtime:",o),o.response?console.error("Error response:",{data:o.response.data,status:o.response.status,headers:o.response.headers}):o.request&&console.error("Error request:",o.request);const u=((t=(i=o.response)==null?void 0:i.data)==null?void 0:t.message)||o.message||"Failed to create showtime. Please try again.";r({text:u,type:"error"})}finally{x(!1)}},z=()=>{D("/admin/ql-thoi-gian-chieu")},N=a=>{console.log("Selected movie ID:",a);const i=y.find(t=>t.movieId===a);console.log("Selected movie data:",i),i&&(Y(i.duration||120),console.log("Setting duration to:",i.duration||120)),P(a),h(t=>({...t,movieId:a})),p(!1)};return e.jsxs(Z,{children:[e.jsx(O,{enableColorScheme:!0}),e.jsxs(l,{sx:{display:"flex",height:"100vh"},children:[e.jsx(V,{}),e.jsxs(l,{sx:{flexGrow:1,display:"flex",flexDirection:"column"},children:[e.jsx(X,{}),e.jsx(l,{component:"main",sx:a=>({flexGrow:1,backgroundColor:M(a.palette.background.default,1),overflowY:"auto",px:3,py:2}),children:e.jsxs(J,{spacing:2,alignItems:"center",children:[e.jsx(ee,{}),e.jsxs(te,{sx:{backgroundColor:"#f5f5f5",color:"#000000",py:3},children:[S.text&&e.jsx(c,{color:S.type==="error"?"error":"success",sx:{mt:2},children:S.text}),e.jsxs(l,{sx:{mt:2,display:"flex",gap:2,flexDirection:"row",alignItems:"center"},children:[e.jsx(c,{variant:"subtitle1",sx:{minWidth:100,textAlign:"right",paddingRight:2},children:m("admin.showtime_management.movie_selection")}),e.jsxs(l,{sx:{display:"flex",width:"100%",gap:2},children:[e.jsx(v,{variant:"contained",color:"primary",onClick:()=>p(!0),sx:{flexShrink:0},children:"Chọn phim"}),e.jsx(l,{sx:{flexGrow:1,display:"flex",alignItems:"center",bgcolor:s.movieId?M("#f5f5f5",.8):"transparent",px:2,py:1,borderRadius:1,border:"1px solid",borderColor:s.movieId?"primary.light":"divider"},children:e.jsx(c,{variant:"body1",sx:{fontWeight:s.movieId?"medium":"normal",color:s.movieId?"text.primary":"text.secondary"},children:s.movieId?((b=y.find(a=>a.movieId===s.movieId))==null?void 0:b.movieName)||"Phim đã chọn":"Chưa chọn phim"})})]})]}),e.jsxs(ae,{open:W,onClose:()=>p(!1),maxWidth:"lg",fullWidth:!0,children:[e.jsx(se,{children:"Chọn phim chiếu"}),e.jsx(oe,{dividers:!0,children:e.jsx(he,{onMovieSelect:N,selectedMovieId:_})}),e.jsx(ie,{children:e.jsx(v,{onClick:()=>p(!1),children:"Đóng"})})]}),e.jsxs(l,{sx:{mt:2,display:"flex",gap:2,flexDirection:"row",alignItems:"center"},children:[e.jsx(c,{variant:"subtitle1",sx:{minWidth:100,textAlign:"right",paddingRight:2},children:m("admin.showtime_management.room_selection")}),e.jsxs(re,{fullWidth:!0,variant:"outlined",size:"small",children:[e.jsx(ne,{id:"room-select-label",children:"Phòng"}),e.jsx(le,{labelId:"room-select-label",id:"room-select",name:"roomId",value:s.roomId,onChange:E,label:"Phòng",children:R.map(a=>e.jsx(de,{value:a.roomId,children:a.roomName||`Phòng ${a.roomId.substring(0,8)}`},a.roomId))})]})]}),e.jsxs(l,{sx:{mt:2,display:"flex",gap:2,flexDirection:"row",alignItems:"center"},children:[e.jsx(c,{variant:"subtitle1",sx:{minWidth:100,textAlign:"right",paddingRight:2},children:m("admin.showtime_management.start_time")}),e.jsx(ce,{dateAdapter:me,children:e.jsx(ge,{value:s.startTime?A(s.startTime):A(),onChange:q,minutesStep:5,views:["year","month","day","hours","minutes"]})}),e.jsxs(c,{children:["Stored value:"," ",s.startTime==null?"null":s.startTime]})]}),s.movieId&&e.jsxs(l,{sx:{mt:2,display:"flex",gap:2,flexDirection:"row",alignItems:"center"},children:[e.jsx(c,{variant:"subtitle1",sx:{minWidth:100,textAlign:"right",paddingRight:2},children:"Thời lượng"}),e.jsxs(c,{variant:"body1",sx:{bgcolor:"#e8f4fd",px:2,py:1,borderRadius:1,border:"1px solid",borderColor:"info.light",color:"text.primary"},children:[$," phút"]})]}),e.jsxs(l,{sx:{mt:3,display:"flex",justifyContent:"center",gap:2},children:[e.jsx(v,{variant:"outlined",color:"primary",size:"large",sx:{minWidth:150},onClick:z,disabled:I,children:m("admin.showtime_management.cancel")}),e.jsx(v,{variant:"contained",color:"primary",size:"large",sx:{minWidth:150},onClick:G,disabled:I,children:m(I?"admin.showtime_management.loading":"admin.showtime_management.add_new")})]})]})]})})]})]})]})};export{ve as default};
