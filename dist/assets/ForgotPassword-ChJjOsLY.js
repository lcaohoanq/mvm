import{z as E,A as T,D as ge,e as we,r as f,u as xe,a as _e,V as p,J as U,j as e,K as ye,C as ve,N as be,x as je,B as y,T as P,l as S,b as O,O as V,v as q,m as M,h as D,Q as Pe,R as Se}from"./index-lVPGhRyu.js";import{c as N,a as C,d as Te}from"./index.esm-BuLOBrrH.js";import{V as K,a as J}from"./VisibilityOff-Bf5XD5Zd.js";const Q=(r,i,a)=>{if(r&&"reportValidity"in r){const s=E(a,i);r.setCustomValidity(s&&s.message||""),r.reportValidity()}},X=(r,i)=>{for(const a in i.fields){const s=i.fields[a];s&&s.ref&&"reportValidity"in s.ref?Q(s.ref,a,r):s&&s.refs&&s.refs.forEach(c=>Q(c,a,r))}},Oe=(r,i)=>{i.shouldUseNativeValidation&&X(r,i);const a={};for(const s in r){const c=E(i.fields,s),n=Object.assign(r[s]||{},{ref:c&&c.ref});if(Ve(i.names||Object.keys(r),s)){const u=Object.assign({},E(a,s));T(u,"root",n),T(a,s,u)}else T(a,s,n)}return a},Ve=(r,i)=>{const a=G(i);return r.some(s=>G(s).match(`^${a}\\.\\d+`))};function G(r){return r.replace(/\]|\[/g,"")}function H(r,i,a){return i===void 0&&(i={}),a===void 0&&(a={}),function(s,c,n){try{return Promise.resolve(function(u,x){try{var m=(i.context,Promise.resolve(r[a.mode==="sync"?"validateSync":"validate"](s,Object.assign({abortEarly:!1},i,{context:c}))).then(function(h){return n.shouldUseNativeValidation&&X({},n),{values:a.raw?Object.assign({},s):h,errors:{}}}))}catch(h){return x(h)}return m&&m.then?m.then(void 0,x):m}(0,function(u){if(!u.inner)throw u;return{values:{},errors:Oe((x=u,m=!n.shouldUseNativeValidation&&n.criteriaMode==="all",(x.inner||[]).reduce(function(h,d){if(h[d.path]||(h[d.path]={message:d.message,type:d.type}),m){var v=h[d.path].types,w=v&&v[d.type];h[d.path]=ge(d.path,m,h,d.type,w?[].concat(w,d.message):d.message)}return h},{})),n)};var x,m}))}catch(u){return Promise.reject(u)}}}const Ce=async(r,i)=>(await we.patch("/auth/otp/verify",{email:r,code:i})).status===200,Re=()=>{var F,A,$;const[r,i]=f.useState("email"),[a,s]=f.useState(""),[c,n]=f.useState(!1),[u,x]=f.useState(!1),[m,h]=f.useState(!1),[d,v]=f.useState(["","","","","",""]),w=f.useRef([]),b=xe(),{t}=_e(),[Y,I]=f.useState(5*60),[k,R]=f.useState(!1),_=f.useRef(null);f.useEffect(()=>{w.current=w.current.slice(0,6)},[]),f.useEffect(()=>{r==="otp"?(I(5*60),R(!0)):(R(!1),_.current&&(clearInterval(_.current),_.current=null))},[r]),f.useEffect(()=>(k&&(_.current=setInterval(()=>{I(o=>o<=1?(clearInterval(_.current),p.error(t("auth.forgot_password.toast.otp_expired","OTP session expired")),b("/"),0):o-1)},1e3)),()=>{_.current&&clearInterval(_.current)}),[k,b,t]);const Z=o=>{const l=Math.floor(o/60),g=o%60;return`${l}:${g<10?"0":""}${g}`},ee=N().shape({email:C().email(t("auth.forgot_password.validation.email_invalid")).required(t("auth.forgot_password.validation.email_required"))}),te=N().shape({password:C().required(t("auth.forgot_password.validation.password_required")).min(8,t("auth.forgot_password.validation.password_length")),confirmPassword:C().required(t("auth.forgot_password.validation.confirm_required")).oneOf([Te("password")],t("auth.forgot_password.validation.passwords_match"))}),{register:re,handleSubmit:se,formState:{errors:W}}=U({resolver:H(ee)}),{register:z,handleSubmit:oe,formState:{errors:j}}=U({resolver:H(te)}),ae=async o=>{try{n(!0);const l=await Pe(o.email);if(!l){p.error(t("auth.forgot_password.toast.email_not_found")),n(!1);return}localStorage.setItem("otp",l),s(o.email),i("otp"),p.success(t("auth.forgot_password.toast.otp_sent","OTP sent to your email")),n(!1)}catch{p.error(t("auth.forgot_password.toast.email_failed")),n(!1)}},ne=o=>l=>{var L;const g=l.target.value;if(g&&!/^\d+$/.test(g))return;const B=[...d];B[o]=g,v(B),g&&o<5&&((L=w.current[o+1])==null||L.focus())},ie=o=>l=>{var g;l.key==="Backspace"&&!d[o]&&o>0&&((g=w.current[o-1])==null||g.focus())},le=async()=>{const o=d.join("");if(o.length!==6){p.error(t("auth.forgot_password.toast.invalid_otp","Please enter a valid 6-digit OTP"));return}try{if(n(!0),!await Ce(a,o)){p.error(t("auth.forgot_password.toast.otp_failed","Invalid OTP. Please try again.")),n(!1);return}p.success(t("auth.forgot_password.toast.otp_verified","OTP verified successfully")),localStorage.removeItem("otp"),i("reset"),n(!1)}catch{p.error(t("auth.forgot_password.toast.otp_failed","Invalid OTP. Please try again.")),n(!1)}},de=async o=>{try{if(n(!0),!await Se({email:a,newPassword:o.password})){p.error(t("auth.forgot_password.toast.reset_failed")),n(!1);return}p.success(t("auth.forgot_password.toast.reset_success")),setTimeout(()=>b("/auth/login"),2e3)}catch{p.error(t("auth.forgot_password.toast.reset_failed")),n(!1)}},ce=()=>{b("/auth/login")},ue=()=>{x(!u)},fe=()=>{h(!m)},pe=async()=>{try{n(!0),p.success(t("auth.forgot_password.toast.otp_resent","OTP resent to your email")),n(!1)}catch{p.error(t("auth.forgot_password.toast.otp_resend_failed","Failed to resend OTP")),n(!1)}},me=()=>{switch(r){case"email":return t("auth.forgot_password.title");case"otp":return t("auth.forgot_password.otp_title","Verify OTP");case"reset":return t("auth.forgot_password.reset_title");default:return""}},he=()=>{switch(r){case"email":return t("auth.forgot_password.subtitle","Enter your email to reset your password");case"otp":return t("auth.forgot_password.otp_subtitle",`Enter the 6-digit code sent to ${a}`);case"reset":return t("auth.forgot_password.reset_subtitle",`Creating new password for ${a}`);default:return""}};return e.jsx(ye,{children:e.jsx(ve,{maxWidth:"sm",sx:{mt:{xs:4,md:8,lg:12}},children:e.jsx(be,{in:!0,timeout:800,children:e.jsx(je,{elevation:3,sx:{mt:{xs:4,md:8},mb:{xs:4,md:8},py:{xs:3,md:4},px:{xs:3,md:5},borderRadius:2,backgroundColor:"rgba(255, 255, 255, 0.9)"},children:e.jsxs(y,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(P,{variant:"h4",component:"h1",sx:{mb:1,fontWeight:600,color:"primary.main"},children:me()}),e.jsx(P,{variant:"body1",color:"text.secondary",align:"center",sx:{mb:4},children:he()}),r==="email"&&e.jsxs(y,{component:"form",onSubmit:se(ae),sx:{width:"100%"},children:[e.jsx(S,{fullWidth:!0,variant:"outlined",label:t("auth.forgot_password.email_label"),...re("email"),error:!!W.email,helperText:(F=W.email)==null?void 0:F.message,sx:{mb:3},autoComplete:"email",autoFocus:!0}),e.jsx(O,{fullWidth:!0,variant:"contained",type:"submit",size:"large",disabled:c,sx:{mt:2,mb:2,py:1.5,fontWeight:600,textTransform:"none",fontSize:"1rem"},children:c?e.jsxs(e.Fragment,{children:[e.jsx(V,{size:24,sx:{mr:1,color:"inherit"}}),t("auth.forgot_password.sending","Sending...")]}):t("auth.forgot_password.send_link")})]}),r==="otp"&&e.jsxs(y,{sx:{width:"100%",display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(y,{sx:{display:"flex",justifyContent:"center",gap:1,mb:4,width:"100%"},children:d.map((o,l)=>e.jsx(S,{inputRef:g=>w.current[l]=g,value:o,onChange:ne(l),onKeyDown:ie(l),variant:"outlined",inputProps:{maxLength:1,style:{textAlign:"center",fontSize:"1.5rem",padding:"12px 0"}},sx:{width:"3rem","& .MuiOutlinedInput-root":{borderRadius:1}},autoFocus:l===0},l))}),e.jsx(P,{variant:"body2",color:"text.secondary",align:"center",sx:{mb:3},children:t("auth.forgot_password.otp_instruction","Please enter the 6-digit one time password (OTP) that was sent to your email")}),e.jsx(O,{fullWidth:!0,variant:"contained",onClick:le,size:"large",disabled:c||d.join("").length!==6,sx:{mt:2,mb:2,py:1.5,fontWeight:600,textTransform:"none",fontSize:"1rem"},children:c?e.jsxs(e.Fragment,{children:[e.jsx(V,{size:24,sx:{mr:1,color:"inherit"}}),t("auth.forgot_password.verifying","Verifying...")]}):t("auth.forgot_password.verify_otp","Verify OTP")}),e.jsx(P,{variant:"body2",color:"error",align:"center",sx:{mb:2},children:t("auth.forgot_password.otp_timer","Time remaining: {{time}}").replace("{{time}}",Z(Y))}),e.jsx(y,{sx:{mt:2,textAlign:"center"},children:e.jsx(q,{component:"button",variant:"body2",onClick:pe,disabled:c,sx:{color:"primary.main"},children:t("auth.forgot_password.resend_otp","Resend OTP")})})]}),r==="reset"&&e.jsxs(y,{component:"form",onSubmit:oe(de),sx:{width:"100%"},children:[e.jsx(S,{fullWidth:!0,type:u?"text":"password",variant:"outlined",label:t("auth.forgot_password.new_password"),...z("password"),error:!!j.password,helperText:(A=j.password)==null?void 0:A.message,sx:{mb:3},autoFocus:!0,InputProps:{endAdornment:e.jsx(M,{position:"end",children:e.jsx(D,{onClick:ue,edge:"end",children:u?e.jsx(K,{}):e.jsx(J,{})})})}}),e.jsx(S,{fullWidth:!0,type:m?"text":"password",variant:"outlined",label:t("auth.forgot_password.confirm_password"),...z("confirmPassword"),error:!!j.confirmPassword,helperText:($=j.confirmPassword)==null?void 0:$.message,sx:{mb:3},InputProps:{endAdornment:e.jsx(M,{position:"end",children:e.jsx(D,{onClick:fe,edge:"end",children:m?e.jsx(K,{}):e.jsx(J,{})})})}}),e.jsx(O,{fullWidth:!0,variant:"contained",type:"submit",size:"large",disabled:c,sx:{mt:2,mb:2,py:1.5,fontWeight:600,textTransform:"none",fontSize:"1rem"},children:c?e.jsxs(e.Fragment,{children:[e.jsx(V,{size:24,sx:{mr:1,color:"inherit"}}),t("auth.forgot_password.resetting","Resetting...")]}):t("auth.forgot_password.reset_button")})]}),e.jsx(y,{sx:{mt:2,textAlign:"center"},children:e.jsx(q,{component:"button",variant:"body2",onClick:ce,sx:{color:"text.secondary"},children:t("auth.forgot_password.back_to_login","Back to Login")})})]})})})})})};export{Re as default};
