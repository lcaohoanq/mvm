import{a4 as W,a6 as P,g as E,r as y,j as e,L as q,x as G,B as d,Z as S,T as v,b as V,V as p,e as L,a7 as O,u as H,U,W as z,X as D,Y as K,_ as Y,$ as Q}from"./index-hKNTF3Dt.js";import{E as R}from"./EventSeat-D8WPZciz.js";const X=({showTimeId:A,selectedSeats:C,setSelectedSeats:w,groupConnected:$})=>{const r=W(),{connection:x}=P(),{userDetails:m}=E(),[B,T]=y.useState([]),[N,k]=y.useState(!0),I=A||sessionStorage.getItem("currentShowTimeId")||"";y.useEffect(()=>{if(!x||!$)return;const t=(c,g)=>{console.log("Seat marked as pending:",c);const o=m==null?void 0:m.userId;g!==o&&(T(i=>i.map(s=>s.seatId===c?{...s,status:1}:s)),w(i=>{const s=i.find(a=>a.id===c);return s?(p.error(`Ghế ${s.name} đã được người khác chọn.`),i.filter(a=>a.id!==c)):i}))},l=c=>{T(g=>g.map(o=>o.seatId===c?{...o,status:2}:o))},n=(c,g)=>{const o=m==null?void 0:m.userId;g!==o&&T(i=>i.map(s=>s.seatId===c?{...s,status:1}:s))},u=c=>{console.log("Received SeatAvailable event for:",c),T(g=>g.map(o=>o.seatId===c?{...o,status:0}:o)),w(g=>g.filter(o=>o.id!==c))};return x.on("SeatPending",t),x.on("SeatBought",l),x.on("SeatSelected",n),x.on("SeatAvailable",u),()=>{x.off("SeatPending",t),x.off("SeatBought",l),x.off("SeatSelected",n),x.off("SeatAvailable",u)}},[x,$,w]),y.useEffect(()=>{(async()=>{if(x&&C.length>0){const l=m==null?void 0:m.userId,n=C.map(u=>({TicketId:u.ticketId,Version:u.version}));try{await x.invoke("ReleasePendingSeats",n,I,l),w([]),p("Các ghế đã được hủy do bạn quay lại.",{position:"top-center"})}catch(u){console.error("Error releasing seats on return:",u)}}})()},[x]),y.useEffect(()=>{I&&(async()=>{var l;try{k(!0);const n=await L.get(`ticketdetail/showtime/${I}`);(l=n.data)!=null&&l.data?T(n.data.data):p.error("Không tìm thấy thông tin ghế.")}catch{p.error("Lỗi khi tải danh sách ghế.")}finally{k(!1)}})()},[I]);const j=async t=>{if(!x){p.error("Mất kết nối đến server!");return}if(t.status===1||t.status===2){const u=t.status===1?"đang được chọn":"đã được mua";p.error(`Ghế ${t.seat.atRow}${t.seat.atColumn} ${u} bởi người khác.`);return}const l=`${t.seat.atRow}${t.seat.atColumn}`,n={id:t.seatId,name:l,version:t.version,ticketId:t.ticketId,roomName:t.seat.roomName,isMine:!0,selectedAt:Date.now()};try{const u=m==null?void 0:m.userId;let c=[...C];const g=C.findIndex(i=>i.ticketId===t.ticketId);g!==-1?C[g].id===t.seatId?c=c.filter(i=>i.ticketId!==t.ticketId):c[g]=n:c.push(n);const o=c.map(i=>({TicketId:i.ticketId,Version:i.version}));console.log("Selecting seat:",l,o,I,u),await x.invoke("SelectSeat",o,I,u),w(i=>{const s=i.find(a=>a.ticketId===t.ticketId);return s?s.id===t.seatId?(p.error(`Bỏ chọn ghế ${l}`),i.filter(a=>a.ticketId!==t.ticketId)):(p.success(`Đổi ghế từ ${s.name} sang ${l}`),i.map(a=>a.ticketId===t.ticketId?n:a)):(p.success(`Chọn ghế ${l}`),[...i,n])})}catch(u){p.error("Không thể chọn ghế này. Có thể ghế đã được người khác chọn."),console.error("Error selecting seat:",u)}};return N?e.jsx(q,{}):e.jsxs(G,{elevation:2,sx:{p:3,borderRadius:2,backgroundColor:r.palette.background.paper,color:r.palette.text.primary},children:[e.jsxs(d,{sx:{display:"flex",flexWrap:"wrap",justifyContent:"center",gap:2,mb:4,pb:2,borderBottom:`1px solid ${S(r.palette.divider,.7)}`},children:[e.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(R,{sx:{color:r.palette.info.main}}),e.jsx(v,{variant:"body2",children:"Ghế VIP"})]}),e.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(R,{sx:{color:"#ab47bc"}}),e.jsx(v,{variant:"body2",children:"Ghế Couple"})]}),e.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(R,{sx:{color:r.palette.success.main}}),e.jsx(v,{variant:"body2",children:"Ghế đang chọn"})]}),e.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(R,{sx:{color:r.palette.error.main}}),e.jsx(v,{variant:"body2",children:"Ghế đã bán"})]}),e.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(R,{sx:{color:r.palette.warning.main}}),e.jsx(v,{variant:"body2",children:"Ghế đã chọn"})]})]}),e.jsxs(d,{sx:{textAlign:"center",mb:4,mt:2},children:[e.jsx(d,{sx:{margin:"0 auto",width:"80%",height:"10px",background:`linear-gradient(180deg, ${S(r.palette.primary.main,.6)} 0%, rgba(0,0,0,0) 100%)`,borderRadius:"50% 50% 0 0",padding:"20px 0",position:"relative"}}),e.jsx(v,{variant:"h6",sx:{mt:1,color:r.palette.text.secondary,fontWeight:500},children:"Màn hình"})]}),e.jsx(d,{sx:{display:"flex",justifyContent:"center",alignItems:"center",p:2},children:e.jsx(d,{sx:{maxWidth:600,display:"flex",flexDirection:"column",gap:2},children:Object.entries(B.reduce((t,l)=>(t[l.seat.atRow]||(t[l.seat.atRow]=[]),t[l.seat.atRow].push(l),t),{})).map(([t,l])=>e.jsx(d,{sx:{display:"flex",justifyContent:"center",gap:4},children:l.map(n=>{if(!n.seat.isActive)return e.jsxs(d,{sx:{minWidth:"50px",minHeight:"50px",p:.5,display:"flex",justifyContent:"center",alignItems:"center",border:"1px dashed rgba(255, 255, 255, 0.2)",borderRadius:"4px",opacity:.3,position:"relative"},children:[e.jsx(d,{sx:{position:"absolute",width:"90%",height:"1px",backgroundColor:"rgba(255, 255, 255, 0.3)",transform:"rotate(45deg)"}}),e.jsxs(v,{variant:"body2",align:"center",sx:{color:"rgba(255, 255, 255, 0.5)",fontSize:"0.7rem"},children:[n.seat.atRow,n.seat.atColumn]})]},n.seatId);const u=C.some(M=>M.id===n.seatId&&M.isMine),c=n.status===1,g=n.status===2,o=n.seat.seatType.typeName,i=o==="VIP",s=o==="Couple";let a=r.palette.text.primary,f="transparent",h=r.palette.text.primary,b=!1;return u?(a=r.palette.success.main,f=S(r.palette.success.main,.1),h=r.palette.success.dark):g?(a=r.palette.error.main,f=S(r.palette.error.main,.1),h=r.palette.error.dark,b=!0):c?(a=r.palette.warning.main,f=S(r.palette.warning.main,.1),h=r.palette.warning.dark,b=!0):i?(a="#2196f3",f=S("#2196f3",.1),h="#1976d2"):s&&(a="#ab47bc",f=S("#ab47bc",.1),h="#8e24aa"),e.jsx(V,{variant:"outlined",disabled:b,onClick:()=>j(n),"data-seat-id":n.seatId,"data-status":n.status,sx:{minWidth:"50px",minHeight:"50px",backgroundColor:f,color:h,border:`1px solid ${a}`,p:.5,fontSize:"0.7rem",transition:"all 0.2s ease","&:hover":{backgroundColor:S(a,.15),borderColor:a},"&.Mui-disabled":{backgroundColor:f,color:h,borderColor:a,opacity:.6}},children:e.jsxs(d,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(R,{sx:{color:a}}),e.jsxs(v,{variant:"body2",align:"center",sx:{color:h},children:[n.seat.atRow,n.seat.atColumn]})]})},n.seatId)})},t))})})]})},F=()=>{const A=O(),C=H(),{connection:w,isConnected:$}=P(),{userDetails:r}=E(),{movieId:x,selectedTime:m,selectedDate:B,tickets:T,movieData:N}=A.state||{movieId:"",selectedTime:"Not selected",selectedDate:new Date().toISOString().split("T")[0],tickets:[],movieData:{}},[k]=y.useState(!1),I=sessionStorage.getItem("currentShowTimeId")||"",[j,t]=y.useState([]),[l,n]=y.useState(null),[u,c]=y.useState(0);y.useCallback(()=>{p.error("Thời gian giữ chỗ đã hết cho tất cả ghế đã chọn."),t([])},[]);const g=y.useCallback(s=>{t(a=>{const f=typeof s=="function"?s(a):s;return f.length!==a.length&&(n(Date.now()),c(h=>h+1)),f})},[]),o=(T||[]).reduce((s,a)=>s+(a.quantity||0),0);y.useEffect(()=>{j.length===0&&n(null)},[j]);const i=async()=>{if(j.length!==o){p.error(`Vui lòng chọn đúng ${o} ghế.`);return}if(!w){p.error("Mất kết nối đến server!");return}try{const s=r==null?void 0:r.userId,a=j.filter(h=>{const b=document.querySelector(`[data-seat-id="${h.id}"]`);return(b==null?void 0:b.getAttribute("data-status"))==="1"||(b==null?void 0:b.getAttribute("data-status"))==="2"});if(a.length>0){const h=a.map(b=>b.name).join(", ");p.error(`Ghế ${h} đã được người khác chọn. Vui lòng chọn ghế khác.`);return}const f=j.map(h=>({TicketId:h.ticketId,Version:h.version}));await w.invoke("SetSeatPending",f,I,s),p.success("Chuyển đến trang thanh toán..."),C("/admin/ql-ban-ve/payment",{state:{movieId:x,selectedDate:B,selectedTime:m,tickets:T,seats:j.map(h=>h.name),selectedSeatsInfo:j,showTimeId:I,lastSelectionTime:l,resetCounter:u,movieData:N,roomName:j[0].roomName}})}catch(s){console.error("Error when booking:",s),p.error("Lỗi khi đặt chỗ! Có thể ghế đã được người khác chọn.")}};return e.jsxs(U,{disableCustomTheme:k,children:[e.jsx(z,{enableColorScheme:!0}),e.jsxs(d,{sx:{display:"flex",height:"100vh"},children:[e.jsx(D,{}),e.jsxs(d,{sx:{flexGrow:1,display:"flex",flexDirection:"column"},children:[e.jsx(K,{}),e.jsx(d,{component:"main",sx:s=>({flexGrow:1,backgroundColor:S(s.palette.background.default,1),overflowY:"auto",px:3,py:2}),children:e.jsxs(Y,{spacing:3,children:[e.jsx(Q,{}),e.jsxs(G,{elevation:2,sx:{width:"100%",borderRadius:2},children:[e.jsxs(d,{sx:{p:3,borderBottom:"1px solid",borderColor:"ActiveBorder",textAlign:"center"},children:[e.jsx(v,{variant:"h5",fontWeight:"bold",gutterBottom:!0,children:"Chọn Ghế"}),e.jsx(v,{variant:"body2",color:"text.secondary",children:`Vui lòng chọn ${o} ghế cho suất chiếu ${m}`})]}),e.jsxs(d,{sx:{p:3},children:[e.jsx(G,{elevation:1,sx:s=>({backgroundColor:S(s.palette.background.default,.6),p:3}),children:e.jsx(d,{sx:{maxWidth:"800px",mx:"auto",borderRadius:2,overflow:"hidden"},children:e.jsx(X,{showTimeId:I,selectedSeats:j,setSelectedSeats:g,groupConnected:$})})}),e.jsxs(d,{sx:{display:"flex",justifyContent:"flex-end",mt:3,gap:2},children:[e.jsx(V,{variant:"outlined",onClick:()=>C(-1),children:"Quay lại"}),e.jsx(V,{variant:"contained",color:"primary",onClick:i,children:"Tiếp tục"})]})]})]})]})})]})]})]})};export{F as default};
