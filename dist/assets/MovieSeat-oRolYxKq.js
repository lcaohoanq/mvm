import{a4 as Y,a5 as D,g as q,a as U,r as j,j as e,L as F,x as V,B as g,a1 as P,T as z,b as L,V as w,e as K,a6 as Q,u as X,Z,_ as J,$ as ee,a0 as te,a2 as ae,a3 as re,d as ne}from"./index-BTfNSLYZ.js";import{E as A}from"./EventSeat-BxYvIvsL.js";import{g as se,m as oe,r as ie,u as k,a as le,c as de}from"./genStyleUtils-t2GhO8j4.js";const ce=({showTimeId:o,selectedSeats:t,setSelectedSeats:y,groupConnected:p,onSeatInfoStored:f})=>{const l=Y(),{connection:m}=D(),{userDetails:S}=q(),{t:u}=U(),[G,M]=j.useState([]),[O,R]=j.useState(!0),T=o||sessionStorage.getItem("currentShowTimeId")||"";j.useEffect(()=>{if(!m||!p)return;const r=(x,c)=>{console.log("Seat marked as pending:",x);const d=S==null?void 0:S.userId;c!==d&&(M(v=>v.map(I=>I.seatId===x?{...I,status:1}:I)),y(v=>{const I=v.find(s=>s.id===x);return I?(w.error(`${I.name} ${u("toast.error.someone_selected")}`),v.filter(s=>s.id!==x)):v}))},h=x=>{M(c=>c.map(d=>d.seatId===x?{...d,status:2}:d))},a=(x,c)=>{const d=S==null?void 0:S.userId;c!==d&&M(v=>v.map(I=>I.seatId===x?{...I,status:1}:I))},b=x=>{console.log("Received SeatAvailable event for:",x),M(c=>c.map(d=>d.seatId===x?{...d,status:0}:d)),y(c=>c.filter(d=>d.id!==x))};return m.on("SeatPending",r),m.on("SeatBought",h),m.on("SeatSelected",a),m.on("SeatAvailable",b),()=>{m.off("SeatPending",r),m.off("SeatBought",h),m.off("SeatSelected",a),m.off("SeatAvailable",b)}},[m,p,y]),j.useEffect(()=>{(async()=>{if(m&&t.length>0){const h=S==null?void 0:S.userId,a=t.map(b=>({TicketId:b.ticketId,Version:b.version}));try{await m.invoke("ReleasePendingSeats",a,T,h),y([]),w(u("toast.error.seat.cancel_booking_bc_back"),{position:"top-center"})}catch(b){console.error("Error releasing seats on return:",b)}}})()},[m]),j.useEffect(()=>{T&&(async()=>{var h;try{R(!0);const a=await K.get(`ticketdetail/showtime/${T}`);(h=a.data)!=null&&h.data?(M(a.data.data),f&&a.data.data.forEach(b=>{b.seat&&b.seat.seatType&&f(b.seatId,b.seat.seatType.seatTypeId,b.seat.seatType.typeName,b.seat.seatType.price)})):w.error(u("toast.error.seat.infor"))}catch{w.error(u("toast.error.seat.loading_list"))}finally{R(!1)}})()},[T,f]);const $=async r=>{if(!m){w.error(u("toast.server.connection"));return}if(r.status===1||r.status===2){const c=r.status===1?u("toast.error.seat.selecting"):u("toast.error.seat.bought");w.error(`${r.seat.atRow}${r.seat.atColumn} ${c} toast.error.seat.by_someone`);return}const h=`${r.seat.atRow}${r.seat.atColumn}`;r.seat.seatType.seatTypeId;const a=r.seat.seatType.typeName,b=r.seat.seatType.price,x={id:r.seatId,name:h,version:r.version,ticketId:r.ticketId,roomName:r.seat.roomName,seatTypeName:a,price:b,isMine:!0,selectedAt:Date.now()};try{const c=S==null?void 0:S.userId;let d=[...t];const v=t.findIndex(s=>s.ticketId===r.ticketId);v!==-1?t[v].id===r.seatId?d=d.filter(s=>s.ticketId!==r.ticketId):d[v]=x:d.push(x);const I=d.map(s=>({TicketId:s.ticketId,Version:s.version}));console.log("Selecting seat:",h,I,T,c),await m.invoke("SelectSeat",I,T,c),y(s=>{const n=s.find(i=>i.ticketId===r.ticketId);return n?n.id===r.seatId?(w.error(`${u("toast.error.seat.cancel_select")} ${h}`),s.filter(i=>i.ticketId!==r.ticketId)):(w.success(`${u("toast.success.seat.change_from")} ${n.name} ${u("toast.success.seat.change_to")} ${h}`),s.map(i=>i.ticketId===r.ticketId?x:i)):(w.success(`${u("toast.success.seat.select")} ${h}`),[...s,x])})}catch(c){w.error(u("toast.error.seat.cannot_selected")),console.error("Error selecting seat:",c)}};return O?e.jsx(F,{}):e.jsxs(V,{elevation:2,sx:{p:3,borderRadius:2,backgroundColor:l.palette.background.paper,color:l.palette.text.primary},children:[e.jsxs(g,{sx:{display:"flex",flexWrap:"wrap",justifyContent:"center",gap:2,mb:4,pb:2,borderBottom:`1px solid ${P(l.palette.divider,.7)}`},children:[e.jsxs(g,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(A,{sx:{color:l.palette.info.main}}),e.jsx(z,{variant:"body2",children:"Ghế VIP"})]}),e.jsxs(g,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(A,{sx:{color:"#ab47bc"}}),e.jsx(z,{variant:"body2",children:"Ghế Couple"})]}),e.jsxs(g,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(A,{sx:{color:l.palette.success.main}}),e.jsx(z,{variant:"body2",children:"Ghế đang chọn"})]}),e.jsxs(g,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(A,{sx:{color:l.palette.error.main}}),e.jsx(z,{variant:"body2",children:"Ghế đã bán"})]}),e.jsxs(g,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(A,{sx:{color:l.palette.warning.main}}),e.jsx(z,{variant:"body2",children:"Ghế đã chọn"})]})]}),e.jsxs(g,{sx:{textAlign:"center",mb:4,mt:2},children:[e.jsx(g,{sx:{margin:"0 auto",width:"80%",height:"10px",backgroundColor:"#121212",borderRadius:"50% 50% 0 0",padding:"20px 0",position:"relative"}}),e.jsx(z,{variant:"h6",sx:{mt:1,color:l.palette.text.secondary,fontWeight:500},children:"Màn hình"})]}),e.jsx(g,{sx:{display:"flex",justifyContent:"center",alignItems:"center",p:2},children:e.jsx(g,{sx:{maxWidth:600,display:"flex",flexDirection:"column",gap:2},children:Object.entries(G.reduce((r,h)=>(r[h.seat.atRow]||(r[h.seat.atRow]=[]),r[h.seat.atRow].push(h),r),{})).map(([r,h])=>e.jsx(g,{sx:{display:"flex",justifyContent:"center",gap:4},children:h.map(a=>{if(!a.seat.isActive)return e.jsxs(g,{sx:{minWidth:"50px",minHeight:"50px",p:.5,display:"flex",justifyContent:"center",alignItems:"center",border:"1px dashed rgba(255, 255, 255, 0.2)",borderRadius:"4px",opacity:.3,position:"relative"},children:[e.jsx(g,{sx:{position:"absolute",width:"90%",height:"1px",backgroundColor:"rgba(255, 255, 255, 0.3)",transform:"rotate(45deg)"}}),e.jsxs(z,{variant:"body2",align:"center",sx:{color:"rgba(255, 255, 255, 0.5)",fontSize:"0.7rem"},children:[a.seat.atRow,a.seat.atColumn]})]},a.seatId);const b=t.some(B=>B.id===a.seatId&&B.isMine),x=a.status===1,c=a.status===2,d=a.seat.seatType.typeName,v=d==="VIP",I=d==="Couple";let s=l.palette.text.primary,n="transparent",i=l.palette.text.primary,_=!1;return b?(s=l.palette.success.main,n=P(l.palette.success.main,.1),i=l.palette.success.dark):c?(s=l.palette.error.main,n=P(l.palette.error.main,.1),i=l.palette.error.dark,_=!0):x?(s=l.palette.warning.main,n=P(l.palette.warning.main,.1),i=l.palette.warning.dark,_=!0):v?(s="#2196f3",n=P("#2196f3",.1),i="#1976d2"):I&&(s="#ab47bc",n=P("#ab47bc",.1),i="#8e24aa"),e.jsx(L,{variant:"outlined",disabled:_,onClick:()=>$(a),"data-seat-id":a.seatId,"data-status":a.status,sx:{minWidth:"50px",minHeight:"50px",backgroundColor:n,color:i,border:`1px solid ${s}`,p:.5,fontSize:"0.7rem",transition:"all 0.2s ease","&:hover":{backgroundColor:P(s,.15),borderColor:s},"&.Mui-disabled":{backgroundColor:n,color:i,borderColor:s,opacity:.6}},children:e.jsxs(g,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(A,{sx:{color:s}}),e.jsxs(z,{variant:"body2",align:"center",sx:{color:i},children:[a.seat.atRow,a.seat.atColumn]})]})},a.seatId)})},r))})})]})},me=o=>{const{componentCls:t,sizePaddingEdgeHorizontal:y,colorSplit:p,lineWidth:f,textPaddingInline:l,orientationMargin:m,verticalMarginInline:S}=o;return{[t]:Object.assign(Object.assign({},ie(o)),{borderBlockStart:`${k(f)} solid ${p}`,"&-vertical":{position:"relative",top:"-0.06em",display:"inline-block",height:"0.9em",marginInline:S,marginBlock:0,verticalAlign:"middle",borderTop:0,borderInlineStart:`${k(f)} solid ${p}`},"&-horizontal":{display:"flex",clear:"both",width:"100%",minWidth:"100%",margin:`${k(o.dividerHorizontalGutterMargin)} 0`},[`&-horizontal${t}-with-text`]:{display:"flex",alignItems:"center",margin:`${k(o.dividerHorizontalWithTextGutterMargin)} 0`,color:o.colorTextHeading,fontWeight:500,fontSize:o.fontSizeLG,whiteSpace:"nowrap",textAlign:"center",borderBlockStart:`0 ${p}`,"&::before, &::after":{position:"relative",width:"50%",borderBlockStart:`${k(f)} solid transparent`,borderBlockStartColor:"inherit",borderBlockEnd:0,transform:"translateY(50%)",content:"''"}},[`&-horizontal${t}-with-text-start`]:{"&::before":{width:`calc(${m} * 100%)`},"&::after":{width:`calc(100% - ${m} * 100%)`}},[`&-horizontal${t}-with-text-end`]:{"&::before":{width:`calc(100% - ${m} * 100%)`},"&::after":{width:`calc(${m} * 100%)`}},[`${t}-inner-text`]:{display:"inline-block",paddingBlock:0,paddingInline:l},"&-dashed":{background:"none",borderColor:p,borderStyle:"dashed",borderWidth:`${k(f)} 0 0`},[`&-horizontal${t}-with-text${t}-dashed`]:{"&::before, &::after":{borderStyle:"dashed none none"}},[`&-vertical${t}-dashed`]:{borderInlineStartWidth:f,borderInlineEnd:0,borderBlockStart:0,borderBlockEnd:0},"&-dotted":{background:"none",borderColor:p,borderStyle:"dotted",borderWidth:`${k(f)} 0 0`},[`&-horizontal${t}-with-text${t}-dotted`]:{"&::before, &::after":{borderStyle:"dotted none none"}},[`&-vertical${t}-dotted`]:{borderInlineStartWidth:f,borderInlineEnd:0,borderBlockStart:0,borderBlockEnd:0},[`&-plain${t}-with-text`]:{color:o.colorText,fontWeight:"normal",fontSize:o.fontSize},[`&-horizontal${t}-with-text-start${t}-no-default-orientation-margin-start`]:{"&::before":{width:0},"&::after":{width:"100%"},[`${t}-inner-text`]:{paddingInlineStart:y}},[`&-horizontal${t}-with-text-end${t}-no-default-orientation-margin-end`]:{"&::before":{width:"100%"},"&::after":{width:0},[`${t}-inner-text`]:{paddingInlineEnd:y}}})}},pe=o=>({textPaddingInline:"1em",orientationMargin:.05,verticalMarginInline:o.marginXS}),ue=se("Divider",o=>{const t=oe(o,{dividerHorizontalWithTextGutterMargin:o.margin,dividerHorizontalGutterMargin:o.marginLG,sizePaddingEdgeHorizontal:0});return[me(t)]},pe,{unitless:{orientationMargin:!0}});var he=function(o,t){var y={};for(var p in o)Object.prototype.hasOwnProperty.call(o,p)&&t.indexOf(p)<0&&(y[p]=o[p]);if(o!=null&&typeof Object.getOwnPropertySymbols=="function")for(var f=0,p=Object.getOwnPropertySymbols(o);f<p.length;f++)t.indexOf(p[f])<0&&Object.prototype.propertyIsEnumerable.call(o,p[f])&&(y[p[f]]=o[p[f]]);return y};const xe=o=>{const{getPrefixCls:t,direction:y,className:p,style:f}=le("divider"),{prefixCls:l,type:m="horizontal",orientation:S="center",orientationMargin:u,className:G,rootClassName:M,children:O,dashed:R,variant:T="solid",plain:$,style:r}=o,h=he(o,["prefixCls","type","orientation","orientationMargin","className","rootClassName","children","dashed","variant","plain","style"]),a=t("divider",l),[b,x,c]=ue(a),d=!!O,v=j.useMemo(()=>S==="left"?y==="rtl"?"end":"start":S==="right"?y==="rtl"?"start":"end":S,[y,S]),I=v==="start"&&u!=null,s=v==="end"&&u!=null,n=de(a,p,x,c,`${a}-${m}`,{[`${a}-with-text`]:d,[`${a}-with-text-${v}`]:d,[`${a}-dashed`]:!!R,[`${a}-${T}`]:T!=="solid",[`${a}-plain`]:!!$,[`${a}-rtl`]:y==="rtl",[`${a}-no-default-orientation-margin-start`]:I,[`${a}-no-default-orientation-margin-end`]:s},G,M),i=j.useMemo(()=>typeof u=="number"?u:/^\d+$/.test(u)?Number(u):u,[u]),_={marginInlineStart:I?i:void 0,marginInlineEnd:s?i:void 0};return b(j.createElement("div",Object.assign({className:n,style:Object.assign(Object.assign({},f),r)},h,{role:"separator"}),O&&m!=="vertical"&&j.createElement("span",{className:`${a}-inner-text`,style:_},O)))},ye=()=>{const o=Q(),{t}=U(),y=X(),{connection:p,isConnected:f}=D(),{userDetails:l}=q(),{movieId:m,showTimeId:S,selectedTime:u,selectedDate:G,movieData:M}=o.state||{movieId:"",showTimeId:"",selectedTime:"Not selected",selectedDate:new Date().toISOString().split("T")[0],movieData:{}},[O]=j.useState(!1),R="adult",T=sessionStorage.getItem("currentShowTimeId")||"",[$,r]=j.useState([]),[h,a]=j.useState(null),[b,x]=j.useState(0),[c,d]=j.useState({});j.useCallback(()=>{w.error(t("toast.error.seat.remainder")),r([])},[t]);const v=j.useCallback(n=>{r(i=>{const B=(typeof n=="function"?n(i):n).map(E=>!E.ticketType&&!i.find(H=>H.id===E.id)?{...E,ticketType:R}:E);return B.length!==i.length&&(a(Date.now()),x(E=>E+1)),B})},[]);j.useEffect(()=>{$.length===0&&a(null)},[$]);const I=j.useCallback((n,i,_,B)=>{d(E=>({...E,[n]:{price:B,name:_}}))},[]),s=async()=>{var n;if($.length===0){w.error(t("toast.error.seat.min_selection"));return}if(!p){w.error(t("toast.error.server.connection"));return}try{const i=l==null?void 0:l.userId,_=$.filter(C=>{const N=document.querySelector(`[data-seat-id="${C.id}"]`);return(N==null?void 0:N.getAttribute("data-status"))==="1"||(N==null?void 0:N.getAttribute("data-status"))==="2"});if(_.length>0){const C=_.map(N=>N.name).join(", ");w.error(`${C} ${t("toast.error.seat.someone_selected")}`);return}const B=$.map(C=>({TicketId:C.ticketId,Version:C.version}));await p.invoke("SetSeatPending",B,T,i),w.success(t("toast.success.change_direct.payment"));const E={};$.forEach(C=>{if(c[C.id]){const{price:N,name:W}=c[C.id];E[W]||(E[W]={count:0,price:N,name:W}),E[W].count++}});const H=Object.values(E).map(({name:C,count:N,price:W})=>({id:C.toLowerCase(),type:C,quantity:N,price:W}));H.length===0&&H.push({id:R,type:R,quantity:$.length,price:9e4}),y("/admin/ql-ban-ve/payment",{state:{movieId:m,selectedDate:G,selectedTime:u,tickets:H,seats:$.map(C=>C.name),selectedSeatsInfo:$,showTimeId:T,lastSelectionTime:h,resetCounter:b,movieData:M,roomName:((n=$[0])==null?void 0:n.roomName)||""}})}catch(i){console.error("Error when booking:",i),w.error(t("toast.error.seat.cannot_selected"))}};return e.jsxs(Z,{disableCustomTheme:O,children:[e.jsx(J,{enableColorScheme:!0}),e.jsxs(g,{sx:{display:"flex",height:"100vh"},children:[e.jsx(ee,{}),e.jsxs(g,{sx:{flexGrow:1,display:"flex",flexDirection:"column"},children:[e.jsx(te,{}),e.jsx(g,{component:"main",sx:n=>({flexGrow:1,backgroundColor:P(n.palette.background.default,1),overflowY:"auto",px:3,py:2}),children:e.jsxs(ae,{spacing:3,children:[e.jsx(re,{}),e.jsxs(V,{elevation:2,sx:{width:"100%",borderRadius:2},children:[e.jsxs(g,{sx:{p:3,borderBottom:"1px solid",borderColor:"divider",textAlign:"center"},children:[e.jsx(z,{variant:"h5",fontWeight:"bold",gutterBottom:!0,children:t("step_tracker.select_seat")}),e.jsxs(z,{variant:"body2",color:"text.secondary",children:[t("admin.ticket_management.select_seats_for_showtime")," ",u]})]}),e.jsxs(g,{sx:{p:3},children:[e.jsxs(g,{sx:{mb:3},children:[e.jsxs(z,{variant:"subtitle1",gutterBottom:!0,children:[t("admin.ticket_management.selected_seats"),":"]}),$.length>0?e.jsx(g,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:$.map((n,i)=>e.jsx(ne,{label:`${n.name} ${c[n.id]?`(${c[n.id].name} - ${c[n.id].price.toLocaleString()} VND)`:""}`,color:"primary",variant:"outlined",onDelete:()=>{r(_=>_.filter(B=>B.id!==n.id))}},i))}):e.jsx(z,{variant:"body2",color:"text.secondary",children:t("admin.ticket_management.no_seats_selected")})]}),e.jsx(xe,{}),e.jsx(V,{elevation:1,sx:n=>({backgroundColor:P(n.palette.background.default,.6),p:3,mt:3}),children:e.jsx(g,{sx:{maxWidth:"800px",mx:"auto",borderRadius:2,overflow:"hidden"},children:e.jsx(ce,{showTimeId:T,selectedSeats:$,setSelectedSeats:v,groupConnected:f,onSeatInfoStored:I})})}),e.jsxs(g,{sx:{display:"flex",justifyContent:"flex-end",mt:3,gap:2},children:[e.jsx(L,{variant:"outlined",onClick:()=>y(-1),children:t("admin.ticket_management.come_back")}),e.jsx(L,{variant:"contained",color:"primary",onClick:s,children:t("admin.ticket_management.continue")})]})]})]})]})})]})]})]})};export{ye as default};
